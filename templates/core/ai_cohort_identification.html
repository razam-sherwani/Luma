{% extends 'base.html' %}
{% load static %}

{% block title %}AI Cohort Identification - ProviderPulse{% endblock %}

{% block extra_css %}
<style>
    .cohort-card {
        border-left: 4px solid #007bff;
        transition: all 0.3s ease;
    }
    .cohort-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .priority-high { border-left-color: #dc3545; }
    .priority-medium { border-left-color: #ffc107; }
    .priority-low { border-left-color: #28a745; }
    
    .clinical-impact-very-high { background: linear-gradient(135deg, #ff6b6b, #ee5a52); }
    .clinical-impact-high { background: linear-gradient(135deg, #ffa726, #ff9800); }
    .clinical-impact-medium-high { background: linear-gradient(135deg, #ffeb3b, #fdd835); }
    .clinical-impact-medium { background: linear-gradient(135deg, #4fc3f7, #29b6f6); }
    
    .ai-confidence {
        background: linear-gradient(135deg, #9c27b0, #8e24aa);
    }
    
    .evidence-grade-a { background: #28a745; }
    .evidence-grade-b { background: #ffc107; }
    
    .stat-card {
        border-radius: 12px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    
    .cohort-type-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        border-radius: 12px;
    }
    
    .treatment-gap { background-color: #dc3545; }
    .optimization-opportunity { background-color: #fd7e14; }
    .monitoring-gap { background-color: #ffc107; color: #000; }
    .high-risk { background-color: #e83e8c; }
    .adherence-risk { background-color: #6f42c1; }
    .ai-discovery { background-color: #20c997; }
    
    .patient-preview {
        max-height: 200px;
        overflow-y: auto;
    }
    
    .action-button {
        background: linear-gradient(135deg, #28a745, #20c997);
        border: none;
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.875rem;
        transition: all 0.3s ease;
    }
    
    .action-button:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="mb-1">ü§ñ AI Cohort Identification</h1>
            <p class="text-muted mb-0">Intelligent identification of high-potential patient cohorts using clinical AI</p>
        </div>
        <div class="text-end">
            <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary">‚Üê Back to Dashboard</a>
        </div>
    </div>

    <!-- Statistics -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card stat-card text-center py-3">
                <div class="card-body">
                    <h3 class="mb-1">{{ total_cohorts }}</h3>
                    <small>Cohorts Identified</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card text-center py-3">
                <div class="card-body">
                    <h3 class="mb-1">{{ total_patients_identified }}</h3>
                    <small>Patients in Cohorts</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card text-center py-3">
                <div class="card-body">
                    <h3 class="mb-1">{{ high_priority_cohorts }}</h3>
                    <small>High Priority</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card text-center py-3">
                <div class="card-body">
                    <h3 class="mb-1">{{ cohorts_by_type|length }}</h3>
                    <small>Cohort Types</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="get" class="row align-items-end">
                <div class="col-md-4">
                    <label for="type-filter" class="form-label">Cohort Type</label>
                    <select name="type" id="type-filter" class="form-select">
                        <option value="all" {% if current_type == 'all' %}selected{% endif %}>All Types</option>
                        <option value="treatment_gap" {% if current_type == 'treatment_gap' %}selected{% endif %}>Treatment Gaps</option>
                        <option value="optimization_opportunity" {% if current_type == 'optimization_opportunity' %}selected{% endif %}>Optimization Opportunities</option>
                        <option value="monitoring_gap" {% if current_type == 'monitoring_gap' %}selected{% endif %}>Monitoring Gaps</option>
                        <option value="high_risk" {% if current_type == 'high_risk' %}selected{% endif %}>High Risk</option>
                        <option value="adherence_risk" {% if current_type == 'adherence_risk' %}selected{% endif %}>Adherence Risk</option>
                        <option value="ai_discovery" {% if current_type == 'ai_discovery' %}selected{% endif %}>AI Discovery</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="priority-filter" class="form-label">Minimum Priority Score</label>
                    <select name="priority" id="priority-filter" class="form-select">
                        <option value="50" {% if current_priority == 50 %}selected{% endif %}>50+ (All)</option>
                        <option value="70" {% if current_priority == 70 %}selected{% endif %}>70+ (Medium)</option>
                        <option value="85" {% if current_priority == 85 %}selected{% endif %}>85+ (High)</option>
                        <option value="90" {% if current_priority == 90 %}selected{% endif %}>90+ (Critical)</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <button type="submit" class="btn btn-primary w-100">Apply Filters</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Cohorts Display -->
    {% if cohorts %}
        <div class="row">
            {% for cohort in cohorts %}
                <div class="col-lg-6 col-xl-4 mb-4">
                    <div class="card cohort-card h-100 
                        {% if cohort.priority_score >= 90 %}priority-high
                        {% elif cohort.priority_score >= 75 %}priority-medium
                        {% else %}priority-low{% endif %}">
                        
                        <div class="card-header d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="mb-1">{{ cohort.name }}</h6>
                                <span class="badge cohort-type-badge {{ cohort.type }}">
                                    {{ cohort.type_display }}
                                </span>
                            </div>
                            <div class="text-end">
                                <div class="badge 
                                    {% if cohort.clinical_impact == 'Very High' %}clinical-impact-very-high
                                    {% elif cohort.clinical_impact == 'High' %}clinical-impact-high
                                    {% elif cohort.clinical_impact == 'Medium-High' %}clinical-impact-medium-high
                                    {% else %}clinical-impact-medium{% endif %} text-white">
                                    {{ cohort.clinical_impact }}
                                </div>
                                <div class="small text-muted mt-1">
                                    Priority: {{ cohort.priority_score }}
                                </div>
                            </div>
                        </div>
                        
                        <div class="card-body">
                            <p class="text-muted small mb-2">{{ cohort.description }}</p>
                            
                            <div class="row text-center mb-3">
                                <div class="col-6">
                                    <div class="h4 mb-0 text-primary">{{ cohort.count }}</div>
                                    <small class="text-muted">Patients</small>
                                </div>
                                <div class="col-6">
                                    {% if cohort.ai_confidence %}
                                        <div class="h4 mb-0 text-info">{{ cohort.ai_confidence|floatformat:1 }}</div>
                                        <small class="text-muted">AI Confidence</small>
                                    {% elif cohort.evidence_level %}
                                        <div class="badge evidence-{% if cohort.evidence_level == 'Grade A' %}grade-a{% elif cohort.evidence_level == 'Grade B' %}grade-b{% else %}unknown{% endif %} text-white">
                                            {{ cohort.evidence_level }}
                                        </div>
                                        <small class="d-block text-muted">Evidence</small>
                                    {% endif %}
                                </div>
                            </div>
                            
                            {% if cohort.diagnosis %}
                                <div class="mb-2">
                                    <strong class="small">Diagnosis:</strong>
                                    <span class="small text-muted">{{ cohort.diagnosis }}</span>
                                </div>
                            {% endif %}
                            
                            <div class="mb-3">
                                <strong class="small">Recommended Action:</strong>
                                <p class="small text-muted mb-0">{{ cohort.recommended_action }}</p>
                            </div>
                            
                            {% if cohort.patients %}
                                <div class="patient-preview">
                                    <strong class="small">Sample Patients:</strong>
                                    <div class="mt-1">
                                        {% for patient_data in cohort.patients|slice:":3" %}
                                            <div class="small mb-1">
                                                <span class="badge bg-light text-dark">
                                                    {% if patient_data.patient %}
                                                        {{ patient_data.patient.patient_id }}
                                                    {% else %}
                                                        {{ patient_data.patient_id|default:"Unknown" }}
                                                    {% endif %}
                                                </span>
                                                {% if patient_data.gap_type_display %}
                                                    <span class="text-muted">- {{ patient_data.gap_type_display }}</span>
                                                {% endif %}
                                            </div>
                                        {% endfor %}
                                        {% if cohort.count > 3 %}
                                            <small class="text-muted">+ {{ cohort.count|add:"-3" }} more patients</small>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="card-footer bg-transparent border-0">
                            <button class="btn action-button btn-sm w-100 cohort-details-btn" 
                                    data-cohort-index="{{ forloop.counter0 }}">
                                <i class="fas fa-eye me-1"></i> View Details & Take Action
                            </button>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="card">
            <div class="card-body text-center py-5">
                <div class="mb-3">
                    <i class="fas fa-search fa-3x text-muted"></i>
                </div>
                <h5>No Cohorts Found</h5>
                <p class="text-muted">No patient cohorts match your current filters. Try adjusting the criteria above.</p>
            </div>
        </div>
    {% endif %}
</div>

<!-- Cohort Details Modal -->
<div class="modal fade" id="cohortModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cohortModalTitle">Cohort Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="cohortModalBody">
                <!-- Details will be populated by JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary">Create Action Plan</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function showCohortDetails(cohortIndex) {
    const cohortData = cohortsData[cohortIndex];
    document.getElementById('cohortModalTitle').textContent = cohortData.name;
    
    const modalBody = document.getElementById('cohortModalBody');
    modalBody.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6>Clinical Information</h6>
                <p><strong>Type:</strong> ${cohortData.type_display}</p>
                <p><strong>Clinical Impact:</strong> ${cohortData.clinical_impact}</p>
                <p><strong>Priority Score:</strong> ${cohortData.priority_score}/100</p>
                ${cohortData.evidence_level ? `<p><strong>Evidence Level:</strong> ${cohortData.evidence_level}</p>` : ''}
                ${cohortData.ai_confidence ? `<p><strong>AI Confidence:</strong> ${(cohortData.ai_confidence * 100).toFixed(1)}%</p>` : ''}
            </div>
            <div class="col-md-6">
                <h6>Patient Statistics</h6>
                <p><strong>Total Patients:</strong> ${cohortData.count}</p>
                ${cohortData.diagnosis ? `<p><strong>Primary Diagnosis:</strong> ${cohortData.diagnosis}</p>` : ''}
                <div class="mt-3">
                    <h6>Recommended Action</h6>
                    <div class="alert alert-info">
                        ${cohortData.recommended_action}
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mt-4">
            <h6>Description</h6>
            <p>${cohortData.description}</p>
        </div>
        
        ${cohortData.supporting_data ? `
        <div class="mt-4">
            <h6>Supporting Data</h6>
            <pre class="bg-light p-3 rounded"><code>${JSON.stringify(cohortData.supporting_data, null, 2)}</code></pre>
        </div>
        ` : ''}
    `;
    
    const modal = new bootstrap.Modal(document.getElementById('cohortModal'));
    modal.show();
}

// Filter handling
document.getElementById('type-filter').addEventListener('change', function() {
    this.form.submit();
});

document.getElementById('priority-filter').addEventListener('change', function() {
    this.form.submit();
});
</script>

{{ cohorts_json|json_script:"cohorts-data" }}
<script>
    // Make cohort data available to JavaScript
    const cohortsData = JSON.parse(document.getElementById('cohorts-data').textContent);
    
    // Add event listeners for cohort detail buttons
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.cohort-details-btn').forEach(function(button) {
            button.addEventListener('click', function() {
                const cohortIndex = parseInt(this.getAttribute('data-cohort-index'));
                showCohortDetails(cohortIndex);
            });
        });
    });
</script>
{% endblock %}