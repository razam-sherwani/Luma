{% extends 'base.html' %}

{% block title %}HCP Dashboard - Luma{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1>Healthcare Provider Dashboard</h1>
        <p class="text-muted mb-0">Welcome, Dr. {{ user.username }}!</p>
        {% if user_profile.specialty %}
            <small class="text-muted">Specialty: {{ user_profile.specialty }}</small>
        {% endif %}
    </div>
    <div class="text-end">
        {% if unread_count > 0 %}
            <span class="badge bg-danger fs-6">{{ unread_count }} New Recommendations</span>
        {% endif %}
        <a href="{% url 'research_dashboard' %}" class="btn btn-info ms-2">
            <i class="fas fa-microscope me-1"></i>Research
        </a>
        <a href="{% url 'patient_database' %}" class="btn btn-primary ms-2">My Patients</a>
        {% if user.userprofile.role == 'HCP' %}
            <a href="{% url 'add_patient' %}" class="btn btn-success ms-2">
                <i class="fas fa-plus"></i> Add Patient / Upload EMR
            </a>
        {% endif %}
    </div>
</div>

<!-- Quick Stats -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h3 class="text-primary">{{ patient_stats.total_patients|default:0 }}</h3>
                <p class="card-text">My Patients</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h3 class="text-success">{{ patient_stats.recent_patients|default:0 }}</h3>
                <p class="card-text">Recent Visits (30d)</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h3 class="text-warning">{{ patient_stats.high_risk_patients|default:0 }}</h3>
                <p class="card-text">High Risk Patients</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h3 class="text-info">{{ unread_count }}</h3>
                <p class="card-text">New Recommendations</p>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- HCR Recommendations -->
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">💡 Recommendations from Healthcare Reps</h5>
                <small>Personalized insights and updates</small>
            </div>
            <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                {% if recommendations %}
                    {% for rec in recommendations %}
                        <div class="mb-3 p-2 {% if not rec.is_read %}border-start border-primary border-3 bg-light{% endif %}">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="mb-1 fw-bold">{{ rec.title }}</h6>
                                <div>
                                    <span class="badge bg-{{ rec.priority|lower }}">{{ rec.get_priority_display }}</span>
                                    {% if not rec.is_read %}
                                        <a href="{% url 'mark_recommendation_read' rec.id %}" 
                                           class="btn btn-sm btn-outline-primary ms-1">Mark Read</a>
                                    {% endif %}
                                </div>
                            </div>
                            <p class="mb-1">{{ rec.message }}</p>
                            {% if rec.research_update %}
                                <small class="text-info">
                                    📊 Related Research: {{ rec.research_update.headline }}
                                </small>
                            {% endif %}
                            <br>
                            <small class="text-muted">{{ rec.created_date }}</small>
                        </div>
                        {% if not forloop.last %}<hr>{% endif %}
                    {% endfor %}
                {% else %}
                    <p class="text-muted">No recommendations yet. Healthcare reps will send you personalized insights based on the latest research and your practice needs.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Research Updates for Your Specialty -->
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-0">🔬 Research Updates</h5>
                    {% if user_profile.specialty %}
                        <small>For {{ user_profile.specialty }}</small>
                    {% else %}
                        <small>Latest medical research</small>
                    {% endif %}
                </div>
                <a href="{% url 'research_dashboard' %}" class="btn btn-sm btn-light">
                    <i class="fas fa-external-link-alt"></i>
                </a>
            </div>
            <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                {% if specialty_research %}
                    {% for research in specialty_research %}
                        <div class="mb-2">
                            <strong>
                                <a href="{% url 'research_detail' research.id %}" class="text-decoration-none">
                                    {{ research.headline|truncatechars:80 }}
                                </a>
                            </strong>
                            {% if research.is_high_impact %}
                                <span class="badge bg-warning text-dark ms-1">High Impact</span>
                            {% endif %}
                            <br>
                            <small class="text-muted">
                                {{ research.date|date:"M d, Y" }} • {{ research.source }}
                                {% if research.relevance_score %}
                                    • <i class="fas fa-star text-warning"></i> {{ research.relevance_score|floatformat:1 }}
                                {% endif %}
                            </small>
                            {% if research.abstract %}
                                <p class="small text-muted mt-1 mb-0">{{ research.abstract|truncatechars:100 }}</p>
                            {% endif %}
                        </div>
                        {% if not forloop.last %}<hr class="my-2">{% endif %}
                    {% endfor %}
                {% else %}
                    <div class="text-center py-3">
                        <i class="fas fa-microscope fa-2x text-muted mb-2"></i>
                        <p class="text-muted mb-2">No recent research updates available.</p>
                        <a href="{% url 'research_dashboard' %}" class="btn btn-sm btn-outline-info">
                            Browse All Research
                        </a>
                    </div>
                {% endif %}
                
                {% if specialty_research %}
                <div class="card-footer text-center">
                    <a href="{% url 'research_dashboard' %}" class="btn btn-outline-info btn-sm">
                        <i class="fas fa-plus me-1"></i>View All Research
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- General Research Updates -->
{% if general_research %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">📚 Other Research Updates</h5>
                <small>General medical research that might interest you</small>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for research in general_research %}
                        <div class="col-md-4 mb-3">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title">{{ research.headline }}</h6>
                                    <p class="card-text">
                                        <small class="text-muted">{{ research.specialty }} | {{ research.date }}</small>
                                    </p>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Quick Actions -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">🚀 Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">

                    <div class="col-md-3">
                        <div class="p-3">
                            <a href="{% url 'patient_database' %}" class="text-decoration-none">
                                <div class="mb-2">
                                    <i class="fas fa-users fa-2x text-success"></i>
                                </div>
                                <h6 class="text-success">👥 My Patients</h6>
                                <p class="small text-muted">View and manage your patient database</p>
                            </a>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="p-3">
                            <a href="{% url 'cohort_cluster_network' %}" class="text-decoration-none">
                                <div class="mb-2">
                                    <i class="fas fa-network-wired fa-2x text-info"></i>
                                </div>
                                <h6 class="text-info">🕸️ Cluster Network</h6>
                                <p class="small text-muted">Explore treatment similarity networks</p>
                            </a>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="p-3">
                            <h6>📊 Analytics</h6>
                            <p class="small text-muted">View your engagement patterns</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.bg-high { background-color: #dc3545; }
.bg-medium { background-color: #ffc107; color: #000; }
.bg-low { background-color: #28a745; }
</style>
{% endblock %}