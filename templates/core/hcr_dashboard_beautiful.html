{% extends 'base.html' %}

{% block title %}Healthcare Rep Dashboard - Luma{% endblock %}

{% block extra_head %}
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
{% endblock %}

{% block content %}
<!-- Hero Header -->
<div class="relative overflow-hidden mb-8">
    <div class="glass-morphism rounded-3xl p-6 md:p-8 relative">
        <!-- Background decorations -->
        <div class="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 gradient-info rounded-full opacity-15 animate-float"></div>
        <div class="absolute bottom-0 left-0 -mb-6 -ml-6 w-20 h-20 gradient-success rounded-full opacity-10 animate-float" style="animation-delay: 2s;"></div>
        
        <div class="relative z-10">
            <div class="flex flex-col lg:flex-row items-start justify-between">
                <div class="mb-6 lg:mb-0">
                    <div class="flex items-center space-x-4 mb-4">
                        <div class="w-16 h-16 gradient-primary rounded-full flex items-center justify-center shadow-xl relative">
                            <i class="fas fa-moon text-white text-3xl"></i>
                            <i class="fas fa-cloud text-white text-sm absolute top-1 right-1 opacity-90"></i>
                            <i class="fas fa-cloud text-white text-sm absolute bottom-1 left-1 opacity-80"></i>
                        </div>
                        <div>
                            <h1 class="text-3xl md:text-4xl font-black text-gray-900 mb-1">
                                Healthcare Rep <span class="bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">Dashboard</span>
                            </h1>
                            <p class="text-lg text-gray-700 font-medium">Welcome back, {{ user.username }}!</p>
                            <p class="text-sm text-gray-600">Your intelligent co-pilot for HCP engagement and patient care optimization</p>
                        </div>
                    </div>
                </div>
                
                <!-- Key Metrics -->
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="text-center bg-white/50 rounded-2xl p-4 border border-white/30">
                        <div class="text-2xl font-black text-blue-600 mb-1">{{ total_insights|default:24 }}</div>
                        <div class="text-xs text-gray-600 font-medium">Active Insights</div>
                    </div>
                    <div class="text-center bg-white/50 rounded-2xl p-4 border border-white/30">
                        <div class="text-2xl font-black text-orange-600 mb-1">{{ high_priority_insights|default:7 }}</div>
                        <div class="text-xs text-gray-600 font-medium">High Priority</div>
                    </div>
                    <div class="text-center bg-white/50 rounded-2xl p-4 border border-white/30">
                        <div class="text-2xl font-black text-green-600 mb-1">{{ total_patients_impacted|default:156 }}</div>
                        <div class="text-xs text-gray-600 font-medium">Patients Impacted</div>
                    </div>
                    <div class="text-center bg-white/50 rounded-2xl p-4 border border-white/30">
                        <div class="text-2xl font-black text-purple-600 mb-1" id="patient-count">{{ total_patients|default:1248 }}</div>
                        <div class="text-xs text-gray-600 font-medium">Total Patients</div>
                    </div>
                </div>
            </div>
            
            <!-- Last Updated -->
            <div class="text-xs text-gray-500 mt-4 text-right">
                Last updated: {% now "M d, Y H:i:s" %}
            </div>
        </div>
    </div>
</div>



<!-- Main Dashboard Grid - Two Columns Layout -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
    <!-- Column 1: New Research Alerts -->
    <div class="bg-white/80 backdrop-blur-sm rounded-3xl border border-white/30 shadow-xl overflow-hidden">
        <div class="bg-gradient-to-r from-blue-500 to-cyan-500 text-white p-6">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center">
                    <i class="fas fa-microscope text-white"></i>
                </div>
                <div>
                    <h3 class="text-xl font-bold">New Research Alerts</h3>
                    <p class="text-blue-100 text-sm">Latest studies and findings</p>
                </div>
            </div>
        </div>
        <div class="p-6 max-h-96 overflow-y-auto">
            <!-- DEBUG: Research count: {{ recent_research|length }} -->
            {% for research in recent_research|slice:":5" %}
                <div class="group bg-gradient-to-br from-blue-50 to-cyan-50 rounded-2xl p-4 mb-4 border border-blue-100 hover:shadow-lg hover:scale-105 transition-all duration-300 cursor-pointer">
                    <!-- DEBUG: URL="{{ research.source_url }}" -->
                    {% if research.source_url and research.source_url != '' %}
                        <a href="{{ research.source_url }}" target="_blank" rel="noopener noreferrer" class="block">
                            <h4 class="font-bold text-gray-900 group-hover:text-blue-600 transition-colors mb-2 line-clamp-2">
                                {{ research.headline|default:"AI-Enhanced Cardiac Risk Assessment Tool Shows 94% Accuracy" }}
                                <i class="fas fa-external-link-alt text-xs ml-1 opacity-60"></i>
                                <span class="text-xs text-green-600 ml-2">✅ CLICKABLE</span>
                            </h4>
                            <div class="flex items-center justify-between">
                                <div class="flex flex-col">
                                    <span class="px-3 py-1 bg-blue-200 text-blue-800 text-xs font-semibold rounded-full mb-1">
                                        {{ research.specialty|default:"Cardiology" }}
                                    </span>
                                    <span class="text-xs text-gray-500">{{ research.date|default:"2 days ago" }} • {{ research.source|default:"Medical Journal" }}</span>
                                </div>
                                <i class="fas fa-arrow-right text-blue-500 group-hover:translate-x-1 transition-transform"></i>
                            </div>
                        </a>
                    {% else %}
                        <h4 class="font-bold text-gray-900 group-hover:text-blue-600 transition-colors mb-2 line-clamp-2">
                            {{ research.headline|default:"AI-Enhanced Cardiac Risk Assessment Tool Shows 94% Accuracy" }}
                        </h4>
                        <div class="flex items-center justify-between">
                            <div class="flex flex-col">
                                <span class="px-3 py-1 bg-blue-200 text-blue-800 text-xs font-semibold rounded-full mb-1">
                                    {{ research.specialty|default:"Cardiology" }}
                                </span>
                                <span class="text-xs text-gray-500">{{ research.date|default:"2 days ago" }} • {{ research.source|default:"Medical Journal" }}</span>
                            </div>
                            <i class="fas fa-arrow-right text-blue-500 group-hover:translate-x-1 transition-transform"></i>
                        </div>
                    {% endif %}
                </div>
            {% empty %}
                <div class="group bg-gradient-to-br from-blue-50 to-cyan-50 rounded-2xl p-4 mb-4 border border-blue-100 hover:shadow-lg hover:scale-105 transition-all duration-300 cursor-pointer">
                    <a href="https://www.ahajournals.org/doi/10.1161/CIRCULATIONAHA.123.066017" target="_blank" rel="noopener noreferrer" class="block">
                        <h4 class="font-bold text-gray-900 group-hover:text-blue-600 transition-colors mb-2">
                            AI-Enhanced Cardiac Risk Assessment Tool Shows 94% Accuracy
                            <i class="fas fa-external-link-alt text-xs ml-1 opacity-60"></i>
                        </h4>
                        <div class="flex items-center justify-between">
                            <div class="flex flex-col">
                                <span class="px-3 py-1 bg-blue-200 text-blue-800 text-xs font-semibold rounded-full mb-1">Cardiology</span>
                                <span class="text-xs text-gray-500">2 days ago • New England Journal of Medicine</span>
                            </div>
                            <i class="fas fa-arrow-right text-blue-500 group-hover:translate-x-1 transition-transform"></i>
                        </div>
                    </a>
                </div>
                <div class="group bg-gradient-to-br from-purple-50 to-pink-50 rounded-2xl p-4 mb-4 border border-purple-100 hover:shadow-lg hover:scale-105 transition-all duration-300 cursor-pointer">
                    <a href="https://ascopubs.org/doi/10.1200/JCO.23.00456" target="_blank" rel="noopener noreferrer" class="block">
                        <h4 class="font-bold text-gray-900 group-hover:text-purple-600 transition-colors mb-2">
                            Novel Immunotherapy Shows Promise in Phase III Trials
                            <i class="fas fa-external-link-alt text-xs ml-1 opacity-60"></i>
                        </h4>
                        <div class="flex items-center justify-between">
                            <div class="flex flex-col">
                                <span class="px-3 py-1 bg-purple-200 text-purple-800 text-xs font-semibold rounded-full mb-1">Oncology</span>
                                <span class="text-xs text-gray-500">4 days ago • Journal of Clinical Oncology</span>
                            </div>
                            <i class="fas fa-arrow-right text-purple-500 group-hover:translate-x-1 transition-transform"></i>
                        </div>
                    </a>
                </div>
            {% endfor %}
        </div>
    </div>

    <!-- Column 2: EMR Flags -->
    <div class="bg-white/80 backdrop-blur-sm rounded-3xl border border-white/30 shadow-xl overflow-hidden">
        <div class="bg-gradient-to-r from-green-500 to-emerald-500 text-white p-6">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center">
                    <i class="fas fa-chart-bar text-white"></i>
                </div>
                <div>
                    <h3 class="text-xl font-bold">EMR Flags</h3>
                    <p class="text-green-100 text-sm">Recent data changes</p>
                </div>
            </div>
        </div>
        <div class="p-6 max-h-96 overflow-y-auto">
            {% for emr in recent_emr_data|slice:":5" %}
                <div class="group bg-gradient-to-br from-green-50 to-emerald-50 rounded-2xl p-4 mb-4 border border-green-100 hover:shadow-lg hover:scale-105 transition-all duration-300 cursor-pointer">
                    <a href="{% url 'hcp_profile' emr.hcp.id %}" class="block">
                        <h4 class="font-bold text-gray-900 group-hover:text-green-600 transition-colors mb-1">
                            {{ emr.hcp.name|default:"Dr. Michael Chen" }}
                        </h4>
                        <p class="text-sm text-gray-700 mb-1">{{ emr.metric_name|default:"Patient Volume Increase" }}: {{ emr.value|default:"+23%" }}</p>
                        <div class="flex items-center justify-between">
                            <span class="text-xs text-gray-500">{{ emr.date|default:"Today" }}</span>
                            <i class="fas fa-arrow-right text-green-500 group-hover:translate-x-1 transition-transform"></i>
                        </div>
                    </a>
                </div>
            {% empty %}
                <div class="group bg-gradient-to-br from-green-50 to-emerald-50 rounded-2xl p-4 mb-4 border border-green-100 hover:shadow-lg hover:scale-105 transition-all duration-300 cursor-pointer">
                    <h4 class="font-bold text-gray-900 group-hover:text-green-600 transition-colors mb-1">Dr. Michael Chen</h4>
                    <p class="text-sm text-gray-700 mb-1">Patient Volume Increase: +23%</p>
                    <div class="flex items-center justify-between">
                        <span class="text-xs text-gray-500">Today</span>
                        <i class="fas fa-arrow-right text-green-500 group-hover:translate-x-1 transition-transform"></i>
                    </div>
                </div>
                <div class="group bg-gradient-to-br from-blue-50 to-indigo-50 rounded-2xl p-4 mb-4 border border-blue-100 hover:shadow-lg hover:scale-105 transition-all duration-300 cursor-pointer">
                    <h4 class="font-bold text-gray-900 group-hover:text-blue-600 transition-colors mb-1">Dr. Lisa Rodriguez</h4>
                    <p class="text-sm text-gray-700 mb-1">New Treatment Protocol: Adopted</p>
                    <div class="flex items-center justify-between">
                        <span class="text-xs text-gray-500">Yesterday</span>
                        <i class="fas fa-arrow-right text-blue-500 group-hover:translate-x-1 transition-transform"></i>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Intelligent Recommendations Section -->
<div class="bg-white/80 backdrop-blur-sm rounded-3xl border border-white/30 shadow-xl overflow-hidden mb-8">
    <div class="bg-gradient-to-r from-green-600 to-blue-600 text-white p-6">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                    <i class="fas fa-lightbulb text-white text-xl"></i>
                </div>
                <div>
                    <h2 class="text-2xl font-bold">Intelligent Recommendations</h2>
                    <p class="text-green-100">AI-powered insights from cluster analysis and research</p>
                </div>
            </div>
            <div class="flex space-x-2">
                <a href="{% url 'cohort_cluster_network' %}" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg transition-colors duration-200">
                    <i class="fas fa-project-diagram mr-2"></i>Explore Network
                </a>
            </div>
        </div>
    </div>
    <div class="p-8">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Quick Actions -->
            <div class="bg-gradient-to-br from-green-50 to-blue-50 rounded-2xl p-6 border border-green-200">
                <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center">
                    <i class="fas fa-rocket text-green-600 mr-2"></i>
                    Quick Actions
                </h3>
                <div class="space-y-3">
                    <a href="{% url 'generate_recommendation_page' %}" class="flex items-center justify-between p-3 bg-white rounded-lg border border-green-200 hover:border-green-300 transition-colors duration-200">
                        <div class="flex items-center">
                            <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center mr-3">
                                <i class="fas fa-lightbulb text-green-600 text-sm"></i>
                            </div>
                            <span class="font-medium text-gray-900">Generate Recommendation</span>
                        </div>
                        <i class="fas fa-arrow-right text-green-600"></i>
                    </a>
                    <a href="{% url 'cohort_cluster_network' %}" class="flex items-center justify-between p-3 bg-white rounded-lg border border-green-200 hover:border-green-300 transition-colors duration-200">
                        <div class="flex items-center">
                            <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center mr-3">
                                <i class="fas fa-project-diagram text-green-600 text-sm"></i>
                            </div>
                            <span class="font-medium text-gray-900">Explore Cluster Network</span>
                        </div>
                        <i class="fas fa-arrow-right text-green-600"></i>
                    </a>
                    <div class="text-sm text-gray-600 bg-blue-50 p-3 rounded-lg border border-blue-200">
                        <i class="fas fa-info-circle text-blue-600 mr-2"></i>
                        Select a doctor to analyze their patients and generate evidence-based recommendations
                    </div>
                </div>
            </div>

            <!-- Recent Recommendations -->
            <div class="bg-gradient-to-br from-purple-50 to-pink-50 rounded-2xl p-6 border border-purple-200">
                <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center">
                    <i class="fas fa-chart-line text-purple-600 mr-2"></i>
                    Recent Activity
                </h3>
                <div class="space-y-3">
                    {% if recent_recommendations %}
                        {% for rec in recent_recommendations|slice:":3" %}
                        <a href="{% url 'view_recommendation' rec.id %}" class="block">
                            <div class="flex items-center justify-between p-3 bg-white rounded-lg border border-purple-200 hover:bg-purple-50 hover:border-purple-300 transition-colors duration-200 cursor-pointer">
                                <div class="flex items-center">
                                    <div class="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center mr-3">
                                        <i class="fas fa-file-medical text-purple-600 text-sm"></i>
                                    </div>
                                    <div>
                                        <div class="font-medium text-gray-900 text-sm">{{ rec.recommendation_title|truncatechars:30 }}</div>
                                        <div class="text-xs text-gray-600">{{ rec.hcp.name }}</div>
                                    </div>
                                </div>
                                <span class="text-xs px-2 py-1 rounded-full
                                    {% if rec.status == 'SENT' %}bg-blue-100 text-blue-800
                                    {% elif rec.status == 'VIEWED' %}bg-green-100 text-green-800
                                    {% elif rec.status == 'ACCEPTED' %}bg-green-100 text-green-800
                                    {% else %}bg-gray-100 text-gray-800{% endif %}">
                                    {{ rec.get_status_display }}
                                </span>
                            </div>
                        </a>
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-6">
                            <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-lightbulb text-purple-600 text-2xl"></i>
                            </div>
                            <p class="text-gray-600 text-sm mb-3">No recommendations yet</p>
                            <div class="space-y-2">
                                <a href="{% url 'cohort_cluster_network' %}" class="inline-flex items-center px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors duration-200 text-sm w-full justify-center">
                                    <i class="fas fa-project-diagram mr-2"></i>
                                    Explore Cluster Network
                                </a>
                                {% if all_hcps %}
                                <a href="{% url 'generate_recommendation_page' %}" class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200 text-sm w-full justify-center">
                                    <i class="fas fa-user-md mr-2"></i>
                                    Generate Recommendation
                                </a>
                                {% endif %}
                            </div>
                        </div>
                    {% endif %}
                    
                    <!-- Always show "Create Another" button if user has recommendations -->
                    {% if recent_recommendations %}
                    <div class="mt-4 pt-4 border-t border-purple-200">
                        <a href="{% url 'generate_recommendation_page' %}" class="inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors duration-200 text-sm w-full justify-center">
                            <i class="fas fa-plus mr-2"></i>
                            Create Another Recommendation
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Priority Alerts & Insights Section - Full Width -->
<div id="insights" class="bg-white/80 backdrop-blur-sm rounded-3xl border border-white/30 shadow-xl overflow-hidden mb-8">
    <div class="bg-gradient-to-r from-red-500 to-pink-500 text-white p-4">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center">
                    <i class="fas fa-brain text-white"></i>
                </div>
                <div>
                    <h2 class="text-xl font-bold">Priority Alerts & Insights</h2>
                    <p class="text-red-100 text-sm">AI-generated insights for overdue HCPs and high-priority opportunities</p>
                </div>
            </div>
            <div class="flex items-center space-x-2">
                <div class="px-2 py-1 bg-orange-500/80 rounded-full text-xs font-semibold">
                    {{ overdue_hcps.count|default:3 }} Overdue
                </div>
                <div class="px-2 py-1 bg-white/20 rounded-full text-xs font-semibold">
                    {{ actionable_insights.count|default:5 }} Active
                </div>
                <button onclick="toggleRecommendations()" class="px-3 py-1 bg-white/20 hover:bg-white/30 rounded-full text-xs font-semibold transition-colors duration-200">
                    <i class="fas fa-chevron-up" id="recommendations-toggle"></i>
                </button>
            </div>
        </div>
    </div>
    <div class="p-4" id="recommendations-content">
        <!-- Overdue HCP Recommendations Section -->
        {% if overdue_hcps %}
            <div class="mb-6">
                <div class="flex items-center mb-4">
                    <div class="w-2 h-6 bg-gradient-to-b from-orange-500 to-red-500 rounded-full mr-3"></div>
                    <div>
                        <h3 class="text-lg font-bold text-gray-900">Overdue HCP Recommendations</h3>
                        <p class="text-gray-600 text-xs">Auto-generated recommendations for HCPs not contacted in 30+ days</p>
                    </div>
                </div>
                <div class="max-h-96 overflow-y-auto pr-2">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
                        {% for hcp in overdue_hcps %}
                            <div class="group bg-gradient-to-br from-orange-50 to-red-50 rounded-xl border-l-3 border-orange-400 p-4 hover:shadow-lg hover:scale-[1.02] transition-all duration-200">
                                <div class="flex items-start justify-between mb-3">
                                    <div class="flex items-center space-x-2">
                                        <div class="w-8 h-8 bg-orange-100 rounded-lg flex items-center justify-center">
                                            <i class="fas fa-user-clock text-orange-600 text-sm"></i>
                                        </div>
                                        <div>
                                            <h4 class="font-bold text-gray-900 group-hover:text-orange-600 transition-colors">
                                                {{ hcp.name|default:"Dr. Sarah Johnson" }}
                                            </h4>
                                            <p class="text-xs text-gray-600">{{ hcp.specialty|default:"Internal Medicine" }}</p>
                                        </div>
                                    </div>
                                    <div class="flex flex-col items-end space-y-1">
                                        <span class="px-2 py-1 bg-orange-200 text-orange-800 text-xs font-bold rounded-full">
                                            {{ hcp.days_overdue|default:45 }}d overdue
                                        </span>
                                        <span class="px-2 py-1 bg-red-100 text-red-700 text-xs font-semibold rounded-full">
                                            AUTO
                                        </span>
                                    </div>
                                </div>
                                
                                <div class="bg-white/60 rounded-lg p-3 mb-3">
                                    <h5 class="font-semibold text-gray-900 mb-1 flex items-center text-sm">
                                        <i class="fas fa-lightbulb text-yellow-500 mr-1 text-xs"></i>
                                        Recommended Action
                                    </h5>
                                    <p class="text-gray-700 text-xs leading-relaxed mb-2 line-clamp-3">
                                        {{ hcp.auto_recommendation|default:"Schedule follow-up meeting to discuss recent treatment outcomes for diabetes patients. Review new SGLT-2 inhibitor data and potential patient candidates." }}
                                    </p>
                                    <div class="flex items-center text-xs text-gray-600">
                                        <i class="fas fa-users mr-1"></i>
                                        {{ hcp.patient_count|default:34 }} patients
                                    </div>
                                </div>
                                
                                <div class="flex items-center justify-between">
                                    <div class="text-xs text-gray-600">
                                        <span class="font-medium">Last:</span> {{ hcp.last_contact|default:"45d ago" }}
                                    </div>
                                    <div class="flex space-x-1">
                                        <a href="{% url 'hcp_profile' hcp.id %}" 
                                           class="px-3 py-1 bg-orange-500 hover:bg-orange-600 text-white font-medium rounded-lg text-xs transition-colors duration-200">
                                            View
                                        </a>
                                        <a href="{% url 'create_recommendation' hcp.id %}" 
                                           class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg text-xs transition-colors duration-200">
                                            Create
                                        </a>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            
            <!-- Divider -->
            <div class="border-t border-gray-200 mb-4"></div>
        {% endif %}
        
        <!-- Regular Actionable Insights Section -->
        {% if actionable_insights %}
            <div class="mb-4">
                <div class="flex items-center mb-4">
                    <div class="w-2 h-6 bg-gradient-to-b from-blue-500 to-purple-500 rounded-full mr-3"></div>
                    <div>
                        <h3 class="text-lg font-bold text-gray-900">Priority Insights</h3>
                        <p class="text-gray-600 text-xs">High-value opportunities based on patient data analysis</p>
                    </div>
                </div>
            </div>
            <div class="max-h-96 overflow-y-auto pr-2">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                    {% for insight in actionable_insights %}
                        <div class="group bg-gradient-to-br from-white/70 to-gray-50/70 rounded-xl border-l-3 border-{% if insight.priority_score >= 80 %}red{% elif insight.priority_score >= 60 %}yellow{% else %}blue{% endif %}-400 p-4 hover:shadow-lg hover:scale-[1.02] transition-all duration-200">
                            <div class="flex items-start justify-between mb-3">
                                <div class="flex items-center space-x-2">
                                    <div class="w-8 h-8 bg-{% if insight.priority_score >= 80 %}red{% elif insight.priority_score >= 60 %}yellow{% else %}blue{% endif %}-100 rounded-lg flex items-center justify-center">
                                        {% if insight.insight_type == 'MISSING_TREATMENT' %}
                                            <i class="fas fa-pills text-{% if insight.priority_score >= 80 %}red{% elif insight.priority_score >= 60 %}yellow{% else %}blue{% endif %}-600 text-sm"></i>
                                        {% elif insight.insight_type == 'NEW_RESEARCH' %}
                                            <i class="fas fa-microscope text-{% if insight.priority_score >= 80 %}red{% elif insight.priority_score >= 60 %}yellow{% else %}blue{% endif %}-600 text-sm"></i>
                                        {% elif insight.insight_type == 'PATIENT_COHORT' %}
                                            <i class="fas fa-users text-{% if insight.priority_score >= 80 %}red{% elif insight.priority_score >= 60 %}yellow{% else %}blue{% endif %}-600 text-sm"></i>
                                        {% elif insight.insight_type == 'ENGAGEMENT_OVERDUE' %}
                                            <i class="fas fa-clock text-{% if insight.priority_score >= 80 %}red{% elif insight.priority_score >= 60 %}yellow{% else %}blue{% endif %}-600 text-sm"></i>
                                        {% elif insight.insight_type == 'TREATMENT_GAP' %}
                                            <i class="fas fa-exclamation-triangle text-{% if insight.priority_score >= 80 %}red{% elif insight.priority_score >= 60 %}yellow{% else %}blue{% endif %}-600 text-sm"></i>
                                        {% endif %}
                                    </div>
                                    <div>
                                        <h4 class="font-bold text-gray-900 group-hover:text-{% if insight.priority_score >= 80 %}red{% elif insight.priority_score >= 60 %}yellow{% else %}blue{% endif %}-600 transition-colors text-sm">
                                            {{ insight.title|default:"High-Value Patient Cohort Identified" }}
                                        </h4>
                                    </div>
                                </div>
                                <div class="flex flex-col items-end space-y-1">
                                    <span class="px-2 py-1 bg-{% if insight.priority_score >= 80 %}red{% elif insight.priority_score >= 60 %}yellow{% else %}blue{% endif %}-100 text-{% if insight.priority_score >= 80 %}red{% elif insight.priority_score >= 60 %}yellow{% else %}blue{% endif %}-800 text-xs font-bold rounded-full">
                                        {{ insight.priority_score|default:85 }}%
                                    </span>
                                    <span class="px-2 py-1 bg-gray-100 text-gray-700 text-xs font-semibold rounded-full">
                                        {{ insight.patient_impact|default:23 }}p
                                    </span>
                                </div>
                            </div>
                            
                            <p class="text-gray-700 mb-3 leading-relaxed text-xs line-clamp-3">
                                {{ insight.description|default:"23 diabetes patients under Dr. Johnson's care show suboptimal HbA1c levels despite current treatment. Consider discussing SGLT-2 inhibitor addition based on recent cardiovascular outcome studies." }}
                            </p>
                            
                            <div class="flex items-center justify-between">
                                <div class="text-xs text-gray-600">
                                    <span class="font-semibold">{{ insight.hcp.name|default:"Dr. Sarah Johnson" }}</span> - 
                                    <span>{{ insight.hcp.specialty|default:"Endocrinology" }}</span>
                                </div>
                                <div class="flex space-x-1">
                                    <a href="{% url 'hcp_profile' insight.hcp.id %}" 
                                       class="px-3 py-1 bg-green-500 hover:bg-green-600 text-white font-medium rounded-lg text-xs transition-colors duration-200">
                                        View
                                    </a>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
            </div>
        {% else %}
            <!-- Sample Overdue HCP Recommendations -->
            <div class="mb-6">
                <div class="flex items-center mb-4">
                    <div class="w-2 h-6 bg-gradient-to-b from-orange-500 to-red-500 rounded-full mr-3"></div>
                    <div>
                        <h3 class="text-lg font-bold text-gray-900">Overdue HCP Recommendations</h3>
                        <p class="text-gray-600 text-xs">Auto-generated recommendations for HCPs not contacted in 30+ days</p>
                    </div>
                </div>
                <div class="max-h-96 overflow-y-auto pr-2">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
                        <div class="group bg-gradient-to-br from-orange-50 to-red-50 rounded-xl border-l-3 border-orange-400 p-4 hover:shadow-lg hover:scale-[1.02] transition-all duration-200">
                            <div class="flex items-start justify-between mb-3">
                                <div class="flex items-center space-x-2">
                                    <div class="w-8 h-8 bg-orange-100 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-user-clock text-orange-600 text-sm"></i>
                                    </div>
                                    <div>
                                        <h4 class="font-bold text-gray-900 group-hover:text-orange-600 transition-colors">
                                            Dr. Sarah Johnson
                                        </h4>
                                        <p class="text-xs text-gray-600">Endocrinology</p>
                                    </div>
                                </div>
                                <div class="flex flex-col items-end space-y-1">
                                    <span class="px-2 py-1 bg-orange-200 text-orange-800 text-xs font-bold rounded-full">
                                        45d overdue
                                    </span>
                                    <span class="px-2 py-1 bg-red-100 text-red-700 text-xs font-semibold rounded-full">
                                        AUTO
                                    </span>
                                </div>
                            </div>
                            
                            <div class="bg-white/60 rounded-lg p-3 mb-3">
                                <h5 class="font-semibold text-gray-900 mb-1 flex items-center text-sm">
                                    <i class="fas fa-lightbulb text-yellow-500 mr-1 text-xs"></i>
                                    Recommended Action
                                </h5>
                                <p class="text-gray-700 text-xs leading-relaxed mb-2 line-clamp-3">
                                    Schedule follow-up meeting to discuss recent treatment outcomes for diabetes patients. Review new SGLT-2 inhibitor data and potential patient candidates.
                                </p>
                                <div class="flex items-center text-xs text-gray-600">
                                    <i class="fas fa-users mr-1"></i>
                                    34 patients
                                </div>
                            </div>
                            
                            <div class="flex items-center justify-between">
                                <div class="text-xs text-gray-600">
                                    <span class="font-medium">Last:</span> 45d ago
                                </div>
                                <div class="flex space-x-1">
                                    <button class="px-3 py-1 bg-orange-500 hover:bg-orange-600 text-white font-medium rounded-lg text-xs transition-colors duration-200 opacity-75 cursor-default" title="Sample data - View not available">
                                        View
                                    </button>
                                    <button class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg text-xs transition-colors duration-200 opacity-75 cursor-default" title="Sample data - Create not available">
                                        Create
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="group bg-gradient-to-br from-orange-50 to-red-50 rounded-xl border-l-3 border-orange-400 p-4 hover:shadow-lg hover:scale-[1.02] transition-all duration-200">
                            <div class="flex items-start justify-between mb-3">
                                <div class="flex items-center space-x-2">
                                    <div class="w-8 h-8 bg-orange-100 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-user-clock text-orange-600 text-sm"></i>
                                    </div>
                                    <div>
                                        <h4 class="font-bold text-gray-900 group-hover:text-orange-600 transition-colors">
                                            Dr. Michael Chen
                                        </h4>
                                        <p class="text-xs text-gray-600">Cardiology</p>
                                    </div>
                                </div>
                                <div class="flex flex-col items-end space-y-1">
                                    <span class="px-2 py-1 bg-orange-200 text-orange-800 text-xs font-bold rounded-full">
                                        38d overdue
                                    </span>
                                    <span class="px-2 py-1 bg-red-100 text-red-700 text-xs font-semibold rounded-full">
                                        AUTO
                                    </span>
                                </div>
                            </div>
                            
                            <div class="bg-white/60 rounded-lg p-3 mb-3">
                                <h5 class="font-semibold text-gray-900 mb-1 flex items-center text-sm">
                                    <i class="fas fa-lightbulb text-yellow-500 mr-1 text-xs"></i>
                                    Recommended Action
                                </h5>
                                <p class="text-gray-700 text-xs leading-relaxed mb-2 line-clamp-3">
                                    Discuss recent cardiovascular outcome studies and their application to current patient population. Review lipid management protocols.
                                </p>
                                <div class="flex items-center text-xs text-gray-600">
                                    <i class="fas fa-users mr-1"></i>
                                    28 patients
                                </div>
                            </div>
                            
                            <div class="flex items-center justify-between">
                                <div class="text-xs text-gray-600">
                                    <span class="font-medium">Last:</span> 38d ago
                                </div>
                                <div class="flex space-x-1">
                                    <button class="px-3 py-1 bg-orange-500 hover:bg-orange-600 text-white font-medium rounded-lg text-xs transition-colors duration-200 opacity-75 cursor-default" title="Sample data - View not available">
                                        View
                                    </button>
                                    <button class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg text-xs transition-colors duration-200 opacity-75 cursor-default" title="Sample data - Create not available">
                                        Create
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Divider -->
                <div class="border-t border-gray-200 mb-4"></div>
            </div>
            
            <!-- Sample Priority Insights -->
            <div class="mb-4">
                <div class="flex items-center mb-4">
                    <div class="w-2 h-6 bg-gradient-to-b from-blue-500 to-purple-500 rounded-full mr-3"></div>
                    <div>
                        <h3 class="text-lg font-bold text-gray-900">Priority Insights</h3>
                        <p class="text-gray-600 text-xs">High-value opportunities based on patient data analysis</p>
                    </div>
                </div>
            </div>
            <div class="max-h-96 overflow-y-auto pr-2">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                    <div class="group bg-gradient-to-br from-white/70 to-gray-50/70 rounded-xl border-l-3 border-red-400 p-4 hover:shadow-lg hover:scale-[1.02] transition-all duration-200">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex items-center space-x-2">
                                <div class="w-8 h-8 bg-red-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-pills text-red-600 text-sm"></i>
                                </div>
                                <div>
                                    <h4 class="font-bold text-gray-900 group-hover:text-red-600 transition-colors text-sm">
                                        High-Value Patient Cohort Identified
                                    </h4>
                                </div>
                            </div>
                            <div class="flex flex-col items-end space-y-1">
                                <span class="px-2 py-1 bg-red-100 text-red-800 text-xs font-bold rounded-full">92%</span>
                                <span class="px-2 py-1 bg-gray-100 text-gray-700 text-xs font-semibold rounded-full">23p</span>
                            </div>
                        </div>
                        
                        <p class="text-gray-700 mb-3 leading-relaxed text-xs line-clamp-3">
                            23 diabetes patients under Dr. Rodriguez's care show suboptimal HbA1c levels despite current treatment. Consider discussing SGLT-2 inhibitor addition.
                        </p>
                        
                        <div class="flex items-center justify-between">
                            <div class="text-xs text-gray-600">
                                <span class="font-semibold">Dr. Lisa Rodriguez</span> - <span>Endocrinology</span>
                            </div>
                            <div class="flex space-x-1">
                                <button class="px-3 py-1 bg-green-500 hover:bg-green-600 text-white font-medium rounded-lg text-xs transition-colors duration-200">
                                    View
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="group bg-gradient-to-br from-white/70 to-gray-50/70 rounded-xl border-l-3 border-yellow-400 p-4 hover:shadow-lg hover:scale-[1.02] transition-all duration-200">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex items-center space-x-2">
                                <div class="w-8 h-8 bg-yellow-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-microscope text-yellow-600 text-sm"></i>
                                </div>
                                <div>
                                    <h4 class="font-bold text-gray-900 group-hover:text-yellow-600 transition-colors text-sm">
                                        New Research Application Opportunity
                                    </h4>
                                </div>
                            </div>
                            <div class="flex flex-col items-end space-y-1">
                                <span class="px-2 py-1 bg-yellow-100 text-yellow-800 text-xs font-bold rounded-full">78%</span>
                                <span class="px-2 py-1 bg-gray-100 text-gray-700 text-xs font-semibold rounded-full">45p</span>
                            </div>
                        </div>
                        
                        <p class="text-gray-700 mb-3 leading-relaxed text-xs line-clamp-3">
                            Recent study shows 40% reduction in cardiovascular events with new treatment protocol. Dr. Thompson's patient population matches study demographics perfectly.
                        </p>
                        
                        <div class="flex items-center justify-between">
                            <div class="text-xs text-gray-600">
                                <span class="font-semibold">Dr. James Thompson</span> - <span>Cardiology</span>
                            </div>
                            <div class="flex space-x-1">
                                <button class="px-3 py-1 bg-green-500 hover:bg-green-600 text-white font-medium rounded-lg text-xs transition-colors duration-200">
                                    View
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>
</div>



<!-- Network Visualization Section -->
<div class="bg-white/80 backdrop-blur-sm rounded-3xl border border-white/30 shadow-xl overflow-hidden mb-8">
    <div class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-6">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                    <i class="fas fa-project-diagram text-white text-xl"></i>
                </div>
                <div>
                    <h2 class="text-2xl font-bold">Cohort-Cluster Network</h2>
                    <p class="text-indigo-100">Interactive visualization of patient relationships</p>
                </div>
            </div>
        </div>
    </div>
    <div class="p-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2">
                <div class="bg-gradient-to-br from-gray-50 to-indigo-50 rounded-3xl border-2 border-dashed border-indigo-200 p-12 text-center">
                    <div class="w-24 h-24 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-6">
                        <i class="fas fa-project-diagram text-indigo-600 text-4xl"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-900 mb-4">Interactive Network Visualization</h3>
                    <p class="text-gray-600 mb-6">Explore relationships between clinical cohorts and AI-identified patient clusters</p>
                    <a href="{% url 'cohort_cluster_network' %}" class="inline-flex items-center px-8 py-4 gradient-primary text-white font-bold rounded-2xl hover:shadow-2xl hover:scale-105 transition-all duration-300">
                        <i class="fas fa-external-link-alt mr-3"></i>Open Network View
                    </a>
                </div>
            </div>
            <div class="space-y-6">
                <div>
                    <h3 class="text-lg font-bold text-gray-900 mb-4">Network Features</h3>
                    <div class="space-y-4">
                        <div class="flex items-start space-x-3">
                            <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center flex-shrink-0 mt-1">
                                <i class="fas fa-filter text-blue-600 text-sm"></i>
                            </div>
                            <div>
                                <div class="font-semibold text-gray-900">Smart Filtering</div>
                                <div class="text-sm text-gray-600">Filter by specialty, treatment, diagnosis, and risk level</div>
                            </div>
                        </div>
                        <div class="flex items-start space-x-3">
                            <div class="w-8 h-8 bg-red-100 rounded-lg flex items-center justify-center flex-shrink-0 mt-1">
                                <i class="fas fa-project-diagram text-red-600 text-sm"></i>
                            </div>
                            <div>
                                <div class="font-semibold text-gray-900">Interactive Nodes</div>
                                <div class="text-sm text-gray-600">Click any cluster for detailed patient insights</div>
                            </div>
                        </div>
                        <div class="flex items-start space-x-3">
                            <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center flex-shrink-0 mt-1">
                                <i class="fas fa-download text-green-600 text-sm"></i>
                            </div>
                            <div>
                                <div class="font-semibold text-gray-900">Export Options</div>
                                <div class="text-sm text-gray-600">Download as JSON, CSV, or PNG image</div>
                            </div>
                        </div>
                        <div class="flex items-start space-x-3">
                            <div class="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center flex-shrink-0 mt-1">
                                <i class="fas fa-percentage text-purple-600 text-sm"></i>
                            </div>
                            <div>
                                <div class="font-semibold text-gray-900">Similarity Scores</div>
                                <div class="text-sm text-gray-600">View treatment similarity from 20% to 70%+</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-2xl p-4 border border-blue-200">
                    <div class="flex items-start space-x-3">
                        <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center flex-shrink-0 mt-1">
                            <i class="fas fa-lightbulb text-blue-600"></i>
                        </div>
                        <div>
                            <div class="font-semibold text-blue-900 mb-1">Pro Tip</div>
                            <div class="text-sm text-blue-700">Hover over nodes to see detailed insights and treatment recommendations.</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<!-- JavaScript for Enhanced Functionality -->
<script>
// Auto-refresh functionality
let autoRefreshInterval = null;
let isAutoRefreshEnabled = false;

// Toggle recommendations section
function toggleRecommendations() {
    const content = document.getElementById('recommendations-content');
    const toggle = document.getElementById('recommendations-toggle');
    
    if (content.style.display === 'none') {
        content.style.display = 'block';
        toggle.classList.remove('fa-chevron-down');
        toggle.classList.add('fa-chevron-up');
    } else {
        content.style.display = 'none';
        toggle.classList.remove('fa-chevron-up');
        toggle.classList.add('fa-chevron-down');
    }
}

function refreshRecommendations() {
    const refreshBtn = document.querySelector('button[onclick="refreshRecommendations()"]');
    const originalHTML = refreshBtn.innerHTML;
    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    refreshBtn.disabled = true;
    
    // Show loading state
    const dynamicCards = document.querySelectorAll('.dynamic-card');
    dynamicCards.forEach(card => {
        card.style.opacity = '0.5';
        card.style.transform = 'scale(0.98)';
    });
    
    // Simulate refresh
    setTimeout(() => {
        window.location.reload();
    }, 1500);
}

function toggleAutoRefresh() {
    const toggleBtn = document.querySelector('button[onclick="toggleAutoRefresh()"]');
    const textSpan = document.getElementById('auto-refresh-text');
    
    if (isAutoRefreshEnabled) {
        clearInterval(autoRefreshInterval);
        isAutoRefreshEnabled = false;
        textSpan.innerHTML = '<i class="fas fa-play"></i>';
        toggleBtn.classList.remove('bg-green-200');
        toggleBtn.classList.add('bg-white/20');
    } else {
        autoRefreshInterval = setInterval(() => {
            refreshRecommendations();
        }, 30000);
        isAutoRefreshEnabled = true;
        textSpan.innerHTML = '<i class="fas fa-pause"></i>';
        toggleBtn.classList.remove('bg-white/20');
        toggleBtn.classList.add('bg-green-200');
    }
}

// Enhanced animations and interactions
document.addEventListener('DOMContentLoaded', function() {
    // Animate cards on scroll
    const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
    };
    
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.style.opacity = '1';
                entry.target.style.transform = 'translateY(0)';
            }
        });
    }, observerOptions);
    
    // Observe all animated elements
    document.querySelectorAll('.group, .dynamic-card').forEach(element => {
        element.style.opacity = '0';
        element.style.transform = 'translateY(20px)';
        element.style.transition = 'all 0.6s ease-out';
        observer.observe(element);
    });
    
    // Add pulse animation to dynamic cards
    const dynamicCards = document.querySelectorAll('.dynamic-card');
    dynamicCards.forEach(card => {
        card.style.animation = 'pulse 3s infinite';
        card.style.borderLeft = '4px solid #10b981';
    });
    
    // Smooth scroll for anchor links
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                target.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        });
    });
});

// Add CSS animations
const style = document.createElement('style');
style.textContent = `
    @keyframes pulse {
        0% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.9; transform: scale(1.02); }
        100% { opacity: 1; transform: scale(1); }
    }
    
    .dynamic-card {
        position: relative;
        overflow: hidden;
    }
    
    .dynamic-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(16, 185, 129, 0.1), transparent);
        animation: shimmer 3s infinite;
    }
    
    @keyframes shimmer {
        0% { left: -100%; }
        100% { left: 100%; }
    }
    
    .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    
    .line-clamp-3 {
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}