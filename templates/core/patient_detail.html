{% extends 'base.html' %}

{% block title %}Patient {{ patient.patient_id }} - ProviderPulse{% endblock %}

{% block extra_head %}
<style>
    .patient-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 20px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    
    .info-card {
        background: white;
        border-radius: 20px;
        padding: 1.5rem;
        box-shadow: 0 8px 25px rgba(0,0,0,0.08);
        border: none;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        height: 100%;
    }
    
    .info-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 40px rgba(0,0,0,0.12);
    }
    
    .info-card .card-header {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        border: none;
        border-radius: 15px 15px 0 0;
        padding: 1rem 1.5rem;
        margin: -1.5rem -1.5rem 1.5rem -1.5rem;
    }
    
    .demographics-card .card-header {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }
    
    .medical-card .card-header {
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    }
    
    .insurance-card .card-header {
        background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    }
    
    .emr-card .card-header {
        background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
        color: #333;
    }
    
    .outcome-card .card-header {
        background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
        color: #333;
    }
    
    .info-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 0;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .info-item:last-child {
        border-bottom: none;
    }
    
    .info-label {
        font-weight: 600;
        color: #555;
        min-width: 120px;
    }
    
    .info-value {
        color: #333;
        text-align: right;
    }
    
    .status-badge {
        padding: 0.5rem 1rem;
        border-radius: 50px;
        font-weight: 500;
        font-size: 0.85rem;
    }
    
    .badge-excellent { background: #d4edda; color: #155724; }
    .badge-good { background: #d1ecf1; color: #0c5460; }
    .badge-fair { background: #fff3cd; color: #856404; }
    .badge-poor { background: #f8d7da; color: #721c24; }
    
    .section-title {
        font-size: 1.4rem;
        font-weight: 700;
        color: #333;
        margin-bottom: 1.5rem;
        position: relative;
        padding-left: 20px;
    }
    
    .section-title::before {
        content: '';
        position: absolute;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        width: 4px;
        height: 25px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 2px;
    }
    
    .patient-id-badge {
        background: rgba(255,255,255,0.2);
        padding: 0.5rem 1rem;
        border-radius: 50px;
        font-weight: 600;
        display: inline-block;
    }
    
    .action-buttons {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }
    
    .btn-modern {
        border-radius: 50px;
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        transition: all 0.3s ease;
        border: none;
    }
    
    .btn-modern:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    }
    
    .medical-info-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }
    
    @media (max-width: 768px) {
        .medical-info-grid {
            grid-template-columns: 1fr;
        }
        .action-buttons {
            justify-content: center;
        }
        .patient-header {
            text-align: center;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Patient Header -->
<div class="patient-header">
    <div class="d-flex justify-content-between align-items-center flex-wrap">
        <div>
            <div class="patient-id-badge mb-2">
                <i class="fas fa-user-injured me-2"></i>Patient {{ patient.patient_id }}
            </div>
            <h1 class="mb-2" style="font-size: 2.5rem; font-weight: 700;">{{ patient.primary_diagnosis }}</h1>
            <p class="mb-0 opacity-75" style="font-size: 1.1rem;">
                <i class="fas fa-calendar-alt me-2"></i>{{ patient.age_group }} • {{ patient.get_gender_display }} • {{ patient.get_race_display }}
            </p>
        </div>
        <div class="action-buttons">
            {% if user_role == 'HCP' %}
                <button type="button" class="btn btn-light btn-modern" id="editPatientBtn">
                    <i class="fas fa-edit me-2"></i>Edit Patient
                </button>
                <button type="button" class="btn btn-danger btn-modern" data-bs-toggle="modal" data-bs-target="#deletePatientModal">
                    <i class="fas fa-trash me-2"></i>Delete
                </button>
            {% endif %}
            <a href="{% url 'patient_database' %}" class="btn btn-outline-light btn-modern">
                <i class="fas fa-arrow-left me-2"></i>Back to Patients
            </a>
        </div>
    </div>
</div>

<!-- Patient Information Grid -->
<div class="row g-4 mb-4">
    <!-- Demographics Card -->
    <div class="col-lg-4">
        <div class="card info-card demographics-card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-user me-2"></i>Demographics</h5>
            </div>
            <div class="card-body">
                <!-- View Mode -->
                <div id="demographics-view" class="view-mode">
                    <div class="info-item">
                        <span class="info-label"><i class="fas fa-id-card me-2"></i>Patient ID</span>
                        <span class="info-value">{{ patient.patient_id }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label"><i class="fas fa-birthday-cake me-2"></i>Age Group</span>
                        <span class="info-value">{{ patient.age_group }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label"><i class="fas fa-venus-mars me-2"></i>Gender</span>
                        <span class="info-value">{{ patient.get_gender_display }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label"><i class="fas fa-users me-2"></i>Race</span>
                        <span class="info-value">{{ patient.get_race_display }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label"><i class="fas fa-globe me-2"></i>Ethnicity</span>
                        <span class="info-value">{{ patient.get_ethnicity_display }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label"><i class="fas fa-map-marker-alt me-2"></i>Zip Code</span>
                        <span class="info-value">{{ patient.zip_code_prefix }}</span>
                    </div>
                </div>

                <!-- Edit Mode -->
                <div id="demographics-edit" class="edit-mode" style="display: none;">
                    <form id="patientForm" method="post" action="{% url 'update_patient' patient.patient_id %}">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label class="form-label"><strong>Patient ID:</strong></label>
                            <input type="text" class="form-control" value="{{ patient.patient_id }}" disabled>
                        </div>
                        <div class="mb-3">
                            <label class="form-label"><strong>Age Group:</strong></label>
                            <select name="age_group" class="form-select">
                                <option value="18-25" {% if patient.age_group == "18-25" %}selected{% endif %}>18-25</option>
                                <option value="26-35" {% if patient.age_group == "26-35" %}selected{% endif %}>26-35</option>
                                <option value="36-45" {% if patient.age_group == "36-45" %}selected{% endif %}>36-45</option>
                                <option value="46-55" {% if patient.age_group == "46-55" %}selected{% endif %}>46-55</option>
                                <option value="56-65" {% if patient.age_group == "56-65" %}selected{% endif %}>56-65</option>
                                <option value="66-75" {% if patient.age_group == "66-75" %}selected{% endif %}>66-75</option>
                                <option value="76+" {% if patient.age_group == "76+" %}selected{% endif %}>76+</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label"><strong>Gender:</strong></label>
                            <select name="gender" class="form-select">
                                <option value="M" {% if patient.gender == "M" %}selected{% endif %}>Male</option>
                                <option value="F" {% if patient.gender == "F" %}selected{% endif %}>Female</option>
                                <option value="U" {% if patient.gender == "U" %}selected{% endif %}>Unknown</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label"><strong>Race:</strong></label>
                            <select name="race" class="form-select">
                                <option value="WHITE" {% if patient.race == "WHITE" %}selected{% endif %}>White</option>
                                <option value="BLACK" {% if patient.race == "BLACK" %}selected{% endif %}>Black/African American</option>
                                <option value="ASIAN" {% if patient.race == "ASIAN" %}selected{% endif %}>Asian</option>
                                <option value="HISPANIC" {% if patient.race == "HISPANIC" %}selected{% endif %}>Hispanic/Latino</option>
                                <option value="NATIVE" {% if patient.race == "NATIVE" %}selected{% endif %}>Native American</option>
                                <option value="PACIFIC" {% if patient.race == "PACIFIC" %}selected{% endif %}>Pacific Islander</option>
                                <option value="OTHER" {% if patient.race == "OTHER" %}selected{% endif %}>Other</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label"><strong>Ethnicity:</strong></label>
                            <select name="ethnicity" class="form-select">
                                <option value="HISPANIC" {% if patient.ethnicity == "HISPANIC" %}selected{% endif %}>Hispanic/Latino</option>
                                <option value="NON_HISPANIC" {% if patient.ethnicity == "NON_HISPANIC" %}selected{% endif %}>Non-Hispanic/Latino</option>
                                <option value="UNKNOWN" {% if patient.ethnicity == "UNKNOWN" %}selected{% endif %}>Unknown</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label"><strong>Zip Code:</strong></label>
                            <input type="text" name="zip_code_prefix" class="form-control" value="{{ patient.zip_code_prefix }}" maxlength="5">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Medical Information Card -->
    <div class="col-lg-8">
        <div class="card info-card medical-card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-stethoscope me-2"></i>Medical Information</h5>
            </div>
            <div class="card-body">
                <!-- View Mode -->
                <div id="medical-view" class="view-mode">
                    <div class="medical-info-grid">
                        <div>
                            <div class="mb-4">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-diagnoses text-primary me-2"></i>
                                    <h6 class="mb-0 fw-bold">Primary Diagnosis</h6>
                                </div>
                                <div class="bg-light p-3 rounded-3">
                                    <strong>{{ patient.primary_diagnosis }}</strong>
                                </div>
                            </div>

                            {% if patient.secondary_diagnoses %}
                            <div class="mb-4">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-list-ul text-info me-2"></i>
                                    <h6 class="mb-0 fw-bold">Secondary Diagnoses</h6>
                                </div>
                                <div class="bg-light p-3 rounded-3">
                                    {{ patient.secondary_diagnoses }}
                                </div>
                            </div>
                            {% endif %}

                            {% if patient.comorbidities %}
                            <div class="mb-4">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                                    <h6 class="mb-0 fw-bold">Comorbidities</h6>
                                </div>
                                <div class="bg-light p-3 rounded-3">
                                    {{ patient.comorbidities }}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        
                        <div>
                            <div class="mb-4">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-pills text-success me-2"></i>
                                    <h6 class="mb-0 fw-bold">Current Treatments</h6>
                                </div>
                                <div class="bg-light p-3 rounded-3">
                                    {{ patient.current_treatments|default:"<em>None recorded</em>" }}
                                </div>
                            </div>

                            <div class="mb-4">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-history text-secondary me-2"></i>
                                    <h6 class="mb-0 fw-bold">Treatment History</h6>
                                </div>
                                <div class="bg-light p-3 rounded-3">
                                    {{ patient.treatment_history|default:"<em>None recorded</em>" }}
                                </div>
                            </div>

                            <div class="mb-4">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-chart-line text-primary me-2"></i>
                                    <h6 class="mb-0 fw-bold">Medication Adherence</h6>
                                </div>
                                <div class="text-center">
                                    {% if patient.medication_adherence == "Excellent" %}
                                        <span class="status-badge badge-excellent">
                                            <i class="fas fa-check-circle me-1"></i>Excellent
                                        </span>
                                    {% elif patient.medication_adherence == "Good" %}
                                        <span class="status-badge badge-good">
                                            <i class="fas fa-thumbs-up me-1"></i>Good
                                        </span>
                                    {% elif patient.medication_adherence == "Fair" %}
                                        <span class="status-badge badge-fair">
                                            <i class="fas fa-minus-circle me-1"></i>Fair
                                        </span>
                                    {% elif patient.medication_adherence == "Poor" %}
                                        <span class="status-badge badge-poor">
                                            <i class="fas fa-times-circle me-1"></i>Poor
                                        </span>
                                    {% else %}
                                        <span class="status-badge bg-light text-dark">
                                            <i class="fas fa-question-circle me-1"></i>Not specified
                                        </span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Edit Mode -->
                <div id="medical-edit" class="edit-mode" style="display: none;">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label"><strong>Primary Diagnosis:</strong></label>
                                <input type="text" name="primary_diagnosis" class="form-control" value="{{ patient.primary_diagnosis }}">
                            </div>
                            <div class="mb-3">
                                <label class="form-label"><strong>Secondary Diagnoses:</strong></label>
                                <textarea name="secondary_diagnoses" class="form-control" rows="3">{{ patient.secondary_diagnoses }}</textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label"><strong>Comorbidities:</strong></label>
                                <textarea name="comorbidities" class="form-control" rows="3">{{ patient.comorbidities }}</textarea>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label"><strong>Current Treatments:</strong></label>
                                <textarea name="current_treatments" class="form-control" rows="3">{{ patient.current_treatments }}</textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label"><strong>Treatment History:</strong></label>
                                <textarea name="treatment_history" class="form-control" rows="3">{{ patient.treatment_history }}</textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label"><strong>Medication Adherence:</strong></label>
                                <select name="medication_adherence" class="form-select">
                                    <option value="Excellent" {% if patient.medication_adherence == "Excellent" %}selected{% endif %}>Excellent</option>
                                    <option value="Good" {% if patient.medication_adherence == "Good" %}selected{% endif %}>Good</option>
                                    <option value="Fair" {% if patient.medication_adherence == "Fair" %}selected{% endif %}>Fair</option>
                                    <option value="Poor" {% if patient.medication_adherence == "Poor" %}selected{% endif %}>Poor</option>
                                    <option value="Unknown" {% if patient.medication_adherence == "Unknown" %}selected{% endif %}>Unknown</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Additional Information Row -->
<div class="row g-4 mb-4">
    <!-- Insurance & Access Card -->
    <div class="col-lg-6">
        <div class="card info-card insurance-card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-shield-alt me-2"></i>Insurance & Access</h5>
            </div>
            <div class="card-body">
                <div class="info-item">
                    <span class="info-label"><i class="fas fa-credit-card me-2"></i>Insurance Type</span>
                    <span class="info-value">
                        {% if patient.insurance_type %}
                            <span class="badge bg-primary">{{ patient.insurance_type }}</span>
                        {% else %}
                            <span class="text-muted">Not specified</span>
                        {% endif %}
                    </span>
                </div>
                <div class="info-item">
                    <span class="info-label"><i class="fas fa-pills me-2"></i>Medication Access</span>
                    <span class="info-value">
                        {% if patient.medication_access == "Excellent" %}
                            <span class="status-badge badge-excellent">
                                <i class="fas fa-check-circle me-1"></i>Excellent
                            </span>
                        {% elif patient.medication_access == "Good" %}
                            <span class="status-badge badge-good">
                                <i class="fas fa-thumbs-up me-1"></i>Good
                            </span>
                        {% elif patient.medication_access == "Limited" %}
                            <span class="status-badge badge-fair">
                                <i class="fas fa-exclamation-triangle me-1"></i>Limited
                            </span>
                        {% elif patient.medication_access == "Poor" %}
                            <span class="status-badge badge-poor">
                                <i class="fas fa-times-circle me-1"></i>Poor
                            </span>
                        {% else %}
                            <span class="status-badge bg-light text-dark">
                                <i class="fas fa-question-circle me-1"></i>Not specified
                            </span>
                        {% endif %}
                    </span>
                </div>
                {% if patient.risk_factors %}
                <div class="info-item">
                    <span class="info-label"><i class="fas fa-exclamation-triangle me-2"></i>Risk Factors</span>
                    <div class="info-value text-start">
                        <div class="bg-light p-3 rounded-3 mt-2">
                            {{ patient.risk_factors }}
                        </div>
                    </div>
                </div>
                {% endif %}
                {% if patient.family_history %}
                <div class="info-item">
                    <span class="info-label"><i class="fas fa-users me-2"></i>Family History</span>
                    <div class="info-value text-start">
                        <div class="bg-light p-3 rounded-3 mt-2">
                            {{ patient.family_history }}
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Healthcare Utilization Card -->
    <div class="col-lg-6">
        <div class="card info-card">
            <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Healthcare Utilization</h5>
            </div>
            <div class="card-body">
                <div class="info-item">
                    <span class="info-label"><i class="fas fa-calendar-check me-2"></i>Visit Frequency</span>
                    <span class="info-value">
                        <span class="badge bg-info">{{ patient.visit_frequency|default:"Not specified" }}</span>
                    </span>
                </div>
                <div class="info-item">
                    <span class="info-label"><i class="fas fa-ambulance me-2"></i>Emergency Visits (6m)</span>
                    <span class="info-value">
                        {% if patient.emergency_visits_6m > 3 %}
                            <span class="badge bg-danger">{{ patient.emergency_visits_6m }}</span>
                        {% elif patient.emergency_visits_6m > 1 %}
                            <span class="badge bg-warning">{{ patient.emergency_visits_6m }}</span>
                        {% else %}
                            <span class="badge bg-success">{{ patient.emergency_visits_6m|default:0 }}</span>
                        {% endif %}
                    </span>
                </div>
                <div class="info-item">
                    <span class="info-label"><i class="fas fa-hospital me-2"></i>Hospitalizations (6m)</span>
                    <span class="info-value">
                        {% if patient.hospitalizations_6m > 2 %}
                            <span class="badge bg-danger">{{ patient.hospitalizations_6m }}</span>
                        {% elif patient.hospitalizations_6m > 0 %}
                            <span class="badge bg-warning">{{ patient.hospitalizations_6m }}</span>
                        {% else %}
                            <span class="badge bg-success">{{ patient.hospitalizations_6m|default:0 }}</span>
                        {% endif %}
                    </span>
                </div>
                {% if patient.last_visit_date %}
                <div class="info-item">
                    <span class="info-label"><i class="fas fa-clock me-2"></i>Last Visit</span>
                    <span class="info-value">{{ patient.last_visit_date }}</span>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- EMR Data and Outcomes Section -->
<div class="row g-4 mb-4">
    <div class="col-12">
        <div class="section-title">Clinical Data & Outcomes</div>
    </div>
</div>

<div class="row">
    <!-- Visit Information -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Visit Information</h5>
            </div>
            <div class="card-body">
                <!-- View Mode -->
                <div id="visit-view" class="view-mode">
                    <table class="table table-sm">
                        <tr>
                            <td><strong>Last Visit:</strong></td>
                            <td>{{ patient.last_visit_date }}</td>
                        </tr>
                        <tr>
                            <td><strong>Visit Frequency:</strong></td>
                            <td>{{ patient.visit_frequency }}</td>
                        </tr>
                        <tr>
                            <td><strong>Emergency Visits (6m):</strong></td>
                            <td>{{ patient.emergency_visits_6m }}</td>
                        </tr>
                        <tr>
                            <td><strong>Hospitalizations (6m):</strong></td>
                            <td>{{ patient.hospitalizations_6m }}</td>
                        </tr>
                    </table>
                </div>

                <!-- Edit Mode -->
                <div id="visit-edit" class="edit-mode" style="display: none;">
                    <div class="mb-3">
                        <label class="form-label"><strong>Last Visit:</strong></label>
                        <input type="date" name="last_visit_date" class="form-control" value="{{ patient.last_visit_date|date:'Y-m-d' }}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label"><strong>Visit Frequency:</strong></label>
                        <select name="visit_frequency" class="form-select">
                            <option value="Weekly" {% if patient.visit_frequency == "Weekly" %}selected{% endif %}>Weekly</option>
                            <option value="Monthly" {% if patient.visit_frequency == "Monthly" %}selected{% endif %}>Monthly</option>
                            <option value="Quarterly" {% if patient.visit_frequency == "Quarterly" %}selected{% endif %}>Quarterly</option>
                            <option value="Semi-annually" {% if patient.visit_frequency == "Semi-annually" %}selected{% endif %}>Semi-annually</option>
                            <option value="Annually" {% if patient.visit_frequency == "Annually" %}selected{% endif %}>Annually</option>
                            <option value="As needed" {% if patient.visit_frequency == "As needed" %}selected{% endif %}>As needed</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label"><strong>Emergency Visits (6m):</strong></label>
                        <input type="number" name="emergency_visits_6m" class="form-control" value="{{ patient.emergency_visits_6m }}" min="0">
                    </div>
                    <div class="mb-3">
                        <label class="form-label"><strong>Hospitalizations (6m):</strong></label>
                        <input type="number" name="hospitalizations_6m" class="form-control" value="{{ patient.hospitalizations_6m }}" min="0">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Risk Factors & History -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Risk Factors & History</h5>
            </div>
            <div class="card-body">
                <!-- View Mode -->
                <div id="risk-view" class="view-mode">
                    {% if patient.risk_factors %}
                    <h6>Risk Factors</h6>
                    <p>{{ patient.risk_factors }}</p>
                    {% endif %}

                    {% if patient.family_history %}
                    <h6>Family History</h6>
                    <p>{{ patient.family_history }}</p>
                    {% endif %}

                    <h6>Insurance Type</h6>
                    <p>{{ patient.insurance_type|default:"Not specified" }}</p>

                    <h6>Medication Access</h6>
                    <p>{{ patient.medication_access|default:"Not specified" }}</p>
                </div>

                <!-- Edit Mode -->
                <div id="risk-edit" class="edit-mode" style="display: none;">
                    <div class="mb-3">
                        <label class="form-label"><strong>Risk Factors:</strong></label>
                        <textarea name="risk_factors" class="form-control" rows="3">{{ patient.risk_factors }}</textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label"><strong>Family History:</strong></label>
                        <textarea name="family_history" class="form-control" rows="3">{{ patient.family_history }}</textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label"><strong>Insurance Type:</strong></label>
                        <select name="insurance_type" class="form-select">
                            <option value="Medicare" {% if patient.insurance_type == "Medicare" %}selected{% endif %}>Medicare</option>
                            <option value="Medicaid" {% if patient.insurance_type == "Medicaid" %}selected{% endif %}>Medicaid</option>
                            <option value="Private" {% if patient.insurance_type == "Private" %}selected{% endif %}>Private</option>
                            <option value="Self-pay" {% if patient.insurance_type == "Self-pay" %}selected{% endif %}>Self-pay</option>
                            <option value="Other" {% if patient.insurance_type == "Other" %}selected{% endif %}>Other</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label"><strong>Medication Access:</strong></label>
                        <select name="medication_access" class="form-select">
                            <option value="Excellent" {% if patient.medication_access == "Excellent" %}selected{% endif %}>Excellent</option>
                            <option value="Good" {% if patient.medication_access == "Good" %}selected{% endif %}>Good</option>
                            <option value="Limited" {% if patient.medication_access == "Limited" %}selected{% endif %}>Limited</option>
                            <option value="Poor" {% if patient.medication_access == "Poor" %}selected{% endif %}>Poor</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- EMR Data Points -->
{% if emr_data %}
<div class="row g-4 mb-4">
    <div class="col-12">
        <div class="card info-card emr-card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>EMR Data Points</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th><i class="fas fa-calendar me-1"></i>Date</th>
                                <th><i class="fas fa-tag me-1"></i>Type</th>
                                <th><i class="fas fa-heartbeat me-1"></i>Metric</th>
                                <th><i class="fas fa-chart-bar me-1"></i>Value</th>
                                <th><i class="fas fa-ruler me-1"></i>Unit</th>
                                <th><i class="fas fa-check-circle me-1"></i>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for data_point in emr_data %}
                            <tr>
                                <td><span class="badge bg-light text-dark">{{ data_point.date_recorded }}</span></td>
                                <td><span class="badge bg-primary">{{ data_point.get_data_type_display }}</span></td>
                                <td class="fw-semibold">{{ data_point.metric_name }}</td>
                                <td class="fw-bold text-primary">{{ data_point.value }}</td>
                                <td>{{ data_point.unit|default:"-" }}</td>
                                <td>
                                    {% if data_point.is_abnormal %}
                                        <span class="badge bg-warning text-dark">
                                            <i class="fas fa-exclamation-triangle me-1"></i>Abnormal
                                        </span>
                                    {% else %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-check me-1"></i>Normal
                                        </span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Patient Outcomes -->
{% if outcomes %}
<div class="row g-4 mb-4">
    <div class="col-12">
        <div class="card info-card treatment-card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Treatment Outcomes</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    {% for outcome in outcomes %}
                    <div class="col-lg-6 col-md-12">
                        <div class="treatment-outcome-card bg-light p-3 rounded-3 h-100">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="mb-0 text-primary">
                                    <i class="fas fa-pills me-2"></i>{{ outcome.treatment }}
                                </h6>
                                <span class="badge 
                                    {% if outcome.outcome == 'IMPROVED' %}bg-success
                                    {% elif outcome.outcome == 'STABLE' %}bg-info
                                    {% elif outcome.outcome == 'DETERIORATED' %}bg-danger
                                    {% else %}bg-secondary{% endif %}">
                                    {{ outcome.get_outcome_display }}
                                </span>
                            </div>
                            
                            <div class="row g-2 mb-3">
                                <div class="col-6">
                                    <div class="info-item">
                                        <i class="fas fa-calendar-alt text-primary me-2"></i>
                                        <strong>Date:</strong>
                                    </div>
                                    <div class="ps-4">{{ outcome.outcome_date }}</div>
                                </div>
                                <div class="col-6">
                                    <div class="info-item">
                                        <i class="fas fa-clock text-primary me-2"></i>
                                        <strong>Duration:</strong>
                                    </div>
                                    <div class="ps-4">
                                        {% if outcome.duration_months %}
                                            {{ outcome.duration_months }} months
                                        {% else %}
                                            Not specified
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <div class="info-item mb-2">
                                    <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                                    <strong>Side Effects:</strong>
                                </div>
                                <div class="ps-4 text-muted">{{ outcome.side_effects|default:"None reported" }}</div>
                            </div>

                            {% if outcome.notes %}
                            <div class="mb-0">
                                <div class="info-item mb-2">
                                    <i class="fas fa-sticky-note text-info me-2"></i>
                                    <strong>Notes:</strong>
                                </div>
                                <div class="ps-4 text-muted small">{{ outcome.notes }}</div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Cluster Memberships -->
{% if cluster_memberships %}
<div class="row g-4 mb-4">
    <div class="col-12">
        <div class="card info-card cluster-card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-project-diagram me-2"></i>Patient Clusters</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    {% for membership in cluster_memberships %}
                    <div class="col-lg-6 col-md-12">
                        <div class="cluster-card bg-gradient p-4 rounded-3 border border-primary h-100">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <h6 class="cluster-title text-primary mb-0">
                                    <i class="fas fa-users me-2"></i>{{ membership.cluster.name }}
                                </h6>
                                <span class="similarity-score badge bg-primary">
                                    {{ membership.similarity_score|floatformat:1 }}%
                                </span>
                            </div>
                            
                            <div class="cluster-description mb-3 text-muted">
                                <i class="fas fa-info-circle me-2"></i>{{ membership.cluster.description }}
                            </div>

                            <div class="cluster-meta">
                                <div class="row g-2">
                                    <div class="col-6">
                                        <div class="meta-item">
                                            <i class="fas fa-tag text-info me-1"></i>
                                            <span class="badge bg-info">{{ membership.cluster.get_cluster_type_display }}</span>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="meta-item">
                                            <i class="fas fa-calendar text-success me-1"></i>
                                            <small class="text-muted">{{ membership.assigned_date }}</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Patient Actions -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body text-center">
                <!-- View Mode Actions -->
                <div id="view-actions" class="view-mode">
                    <a href="{% url 'patient_database' %}" class="btn btn-secondary me-2">← Back to Patients</a>
                    {% if user_role == 'HCP' %}
                        <a href="{% url 'add_patient' %}" class="btn btn-primary">Add Another Patient</a>
                    {% endif %}
                </div>

                <!-- Edit Mode Actions -->
                <div id="edit-actions" class="edit-mode" style="display: none;">
                    <button type="submit" form="patientForm" class="btn btn-success me-2">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                    <button type="button" class="btn btn-secondary me-2" id="cancelEditBtn">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <a href="{% url 'patient_database' %}" class="btn btn-outline-secondary">← Back to Patients</a>
                </div>
                    </form>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
{% if user_role == 'HCP' %}
<div class="modal fade" id="deletePatientModal" tabindex="-1" aria-labelledby="deletePatientModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deletePatientModalLabel">Delete Patient</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Warning:</strong> This action cannot be undone.
                </div>
                <p>Are you sure you want to delete patient <strong>{{ patient.patient_id }}</strong>?</p>
                <p><strong>Patient:</strong> {{ patient.primary_diagnosis }}</p>
                <p><strong>Last Visit:</strong> {{ patient.last_visit_date }}</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="post" action="{% url 'delete_patient' patient.patient_id %}" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash"></i> Delete Patient
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const editBtn = document.getElementById('editPatientBtn');
    const cancelBtn = document.getElementById('cancelEditBtn');
    const viewModes = document.querySelectorAll('.view-mode');
    const editModes = document.querySelectorAll('.edit-mode');

    // Toggle edit mode
    if (editBtn) {
        editBtn.addEventListener('click', function() {
            // Hide view modes, show edit modes
            viewModes.forEach(el => el.style.display = 'none');
            editModes.forEach(el => el.style.display = 'block');

            // Change button text
            editBtn.innerHTML = '<i class="fas fa-eye"></i> View Mode';
            editBtn.id = 'viewPatientBtn';

            // Add new event listener for view mode
            editBtn.addEventListener('click', exitEditMode);
        });
    }

    // Cancel edit mode
    if (cancelBtn) {
        cancelBtn.addEventListener('click', exitEditMode);
    }

    function exitEditMode() {
        // Show view modes, hide edit modes
        viewModes.forEach(el => el.style.display = 'block');
        editModes.forEach(el => el.style.display = 'none');

        // Reset button
        const viewBtn = document.getElementById('viewPatientBtn');
        if (viewBtn) {
            viewBtn.innerHTML = '<i class="fas fa-edit"></i> Edit Patient';
            viewBtn.id = 'editPatientBtn';
        }

        // Reload page to reset form values
        location.reload();
    }

    // Form validation
    const patientForm = document.getElementById('patientForm');
    if (patientForm) {
        patientForm.addEventListener('submit', function(e) {
            const primaryDiagnosis = document.querySelector('input[name="primary_diagnosis"]');
            if (primaryDiagnosis && !primaryDiagnosis.value.trim()) {
                e.preventDefault();
                alert('Primary diagnosis is required.');
                primaryDiagnosis.focus();
                return false;
            }
        });
    }
});
</script>

<style>
.edit-mode {
    border-left: 4px solid #007bff;
    padding-left: 10px;
}

.view-mode {
    transition: all 0.3s ease;
}

.edit-mode .form-control,
.edit-mode .form-select {
    border-color: #007bff;
}

.edit-mode .form-control:focus,
.edit-mode .form-select:focus {
    border-color: #0056b3;
    box-shadow: 0 0 0 0.25rem rgba(0, 123, 255, 0.25);
}

.modal-body .alert {
    margin-bottom: 15px;
}
</style>
{% endblock %}

