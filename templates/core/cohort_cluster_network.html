{% extends 'base.html' %}
{% load static %}

{% block title %}Treatment Similarity Network - ProviderPulse{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <div class="container mx-auto px-4 py-8">
        <!-- Header Section -->
        <div class="flex flex-col lg:flex-row lg:justify-between lg:items-center mb-8">
            <div class="mb-4 lg:mb-0">
                <h1 class="text-3xl font-bold text-gray-900 mb-2">Treatment Similarity Network</h1>
                <p class="text-gray-600">Explore how patient clusters share similar treatment patterns</p>
            </div>
            <div class="flex-shrink-0">
                <a href="{% url 'dashboard' %}" class="inline-flex items-center px-4 py-2 bg-white border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 hover:border-gray-400 transition-colors duration-200">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                    </svg>
                    Back to Dashboard
                </a>
        </div>
    </div>

        <!-- Controls Section -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-8">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div>
                    <label for="specialty-filter" class="block text-sm font-medium text-gray-700 mb-2">Specialty</label>
                    <select id="specialty-filter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white">
                                <option value="">All Specialties</option>
                                {% for specialty in specialties %}
                                    <option value="{{ specialty }}" {% if specialty == current_specialty %}selected{% endif %}>{{ specialty }}</option>
                                {% endfor %}
                            </select>
                        </div>
                <div>
                    <label for="treatment-filter" class="block text-sm font-medium text-gray-700 mb-2">Treatment</label>
                    <select id="treatment-filter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white">
                                <option value="">All Treatments</option>
                                {% for treatment in treatments %}
                                    <option value="{{ treatment }}" {% if treatment == current_treatment %}selected{% endif %}>{{ treatment }}</option>
                                {% endfor %}
                            </select>
                        </div>
                <div>
                    <label for="diagnosis-filter" class="block text-sm font-medium text-gray-700 mb-2">Diagnosis</label>
                    <select id="diagnosis-filter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white">
                                <option value="">All Diagnoses</option>
                                {% for diagnosis in diagnoses %}
                                    <option value="{{ diagnosis }}" {% if diagnosis == current_diagnosis %}selected{% endif %}>{{ diagnosis }}</option>
                                {% endfor %}
                            </select>
                        </div>
                <div>
                    <label for="risk-filter" class="block text-sm font-medium text-gray-700 mb-2">Risk Level</label>
                    <select id="risk-filter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white">
                                <option value="">All Risk Levels</option>
                                <option value="high" {% if current_risk == 'high' %}selected{% endif %}>High Risk</option>
                                <option value="medium" {% if current_risk == 'medium' %}selected{% endif %}>Medium Risk</option>
                                <option value="low" {% if current_risk == 'low' %}selected{% endif %}>Low Risk</option>
                            </select>
            </div>
        </div>
    </div>

    <!-- Network Visualization -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200">
            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center p-6 border-b border-gray-200">
                <h5 class="text-lg font-semibold text-gray-900 mb-4 sm:mb-0">Treatment Similarity Network</h5>
                <div class="flex flex-wrap gap-2">
                    <button onclick="exportNetworkData()" class="inline-flex items-center px-3 py-2 bg-green-50 border border-green-200 rounded-lg text-green-700 hover:bg-green-100 hover:border-green-300 transition-colors duration-200 text-sm">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        Export JSON
                    </button>
                    <button onclick="exportNetworkCSV()" class="inline-flex items-center px-3 py-2 bg-blue-50 border border-blue-200 rounded-lg text-blue-700 hover:bg-blue-100 hover:border-blue-300 transition-colors duration-200 text-sm">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        Export CSV
                    </button>
                    <button onclick="exportNetworkImage()" class="inline-flex items-center px-3 py-2 bg-yellow-50 border border-yellow-200 rounded-lg text-yellow-700 hover:bg-yellow-100 hover:border-yellow-300 transition-colors duration-200 text-sm">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        Export PNG
                    </button>
                </div>
            </div>
            <div class="p-6">
                <div id="network-container" class="w-full h-96 border border-gray-200 rounded-lg bg-gray-50">
                        <svg id="network-svg" width="100%" height="100%"></svg>
                </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics -->
<div class="mt-8 grid grid-cols-1 md:grid-cols-4 gap-6">
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 text-center">
        <h3 class="text-2xl font-bold text-blue-600 mb-2" id="node-count">0</h3>
        <p class="text-gray-600">Clusters</p>
                </div>
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 text-center">
        <h3 class="text-2xl font-bold text-green-600 mb-2" id="link-count">0</h3>
        <p class="text-gray-600">Connections</p>
            </div>
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 text-center">
        <h3 class="text-2xl font-bold text-yellow-600 mb-2" id="treatment-count">0</h3>
        <p class="text-gray-600">Unique Treatments</p>
        </div>
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 text-center">
        <h3 class="text-2xl font-bold text-purple-600 mb-2" id="patient-count">0</h3>
        <p class="text-gray-600">Total Patients</p>
            </div>
        </div>
    </div>

    <!-- Legend -->
<div class="mt-8 grid grid-cols-1 lg:grid-cols-2 gap-6">
    <div class="bg-white rounded-xl shadow-sm border border-gray-200">
        <div class="p-6 border-b border-gray-200">
            <h6 class="text-lg font-semibold text-gray-900">Connection Strength</h6>
                </div>
        <div class="p-6">
            <div class="flex items-center mb-3">
                <div class="w-10 h-1 bg-red-500 mr-3 rounded"></div>
                <span class="text-gray-700">High Similarity (70%+)</span>
                    </div>
            <div class="flex items-center mb-3">
                <div class="w-8 h-1 bg-orange-500 mr-3 rounded"></div>
                <span class="text-gray-700">Medium Similarity (40-70%)</span>
                    </div>
            <div class="flex items-center">
                <div class="w-6 h-1 bg-green-500 mr-3 rounded"></div>
                <span class="text-gray-700">Low Similarity (20-40%)</span>
            </div>
        </div>
                </div>
    <div class="bg-white rounded-xl shadow-sm border border-gray-200">
        <div class="p-6 border-b border-gray-200">
            <h6 class="text-lg font-semibold text-gray-900">Cluster Sizes</h6>
                    </div>
        <div class="p-6">
            <div class="flex items-center mb-3">
                <div class="w-5 h-5 bg-blue-500 rounded-full mr-3"></div>
                <span class="text-gray-700">Large Groups (100+ patients)</span>
                    </div>
            <div class="flex items-center mb-3">
                <div class="w-4 h-4 bg-green-500 rounded-full mr-3"></div>
                <span class="text-gray-700">Medium Groups (50-99 patients)</span>
                    </div>
            <div class="flex items-center">
                <div class="w-3 h-3 bg-yellow-500 rounded-full mr-3"></div>
                <span class="text-gray-700">Small Groups (5-49 patients)</span>
            </div>
        </div>
    </div>
</div>

<!-- Cluster Details Modal -->
<div id="clusterDetailsModal" class="hidden fixed inset-0 z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center p-6 border-b">
            <h5 class="text-xl font-semibold text-gray-900" id="clusterDetailsTitle">Cluster Details</h5>
            <button id="closeClusterModal" class="text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
            </div>
        <div class="p-6">
            <div id="clusterDetailsBody">
                <!-- Content will be populated by JavaScript -->
            </div>
        </div>
        <div class="flex justify-end p-6 border-t">
            <button id="closeClusterModalBtn" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">Close</button>
        </div>
    </div>
</div>

<!-- Tooltip -->
<div id="tooltip" class="tooltip" style="display: none;"></div>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
// Network data from Django
const nodes = {{ nodes|safe }};
const links = {{ links|safe }};

console.log('Treatment similarity network data loaded:', { nodes: nodes.length, links: links.length });

// Global variables
let selectedNode = null;
let labelsVisible = true;

// Check if we have data
if (!nodes || !Array.isArray(nodes) || nodes.length === 0) {
    console.warn('No nodes data available for network visualization');
    document.getElementById('network-svg').innerHTML = '<text x="50%" y="50%" text-anchor="middle" font-size="16" fill="#666">No cluster data available for treatment similarity analysis</text>';
} else {
    // Initialize the network
    console.log("About to initialize network with nodes:", nodes.length, "and links:", links.length);
    initializeNetwork();
}

function initializeNetwork() {
    console.log('Initializing treatment similarity network with', nodes.length, 'clusters and', links.length, 'connections');
    
    const svg = d3.select("#network-svg");
    const container = svg.append("g");
    
    // Set up zoom
    const zoom = d3.zoom()
        .scaleExtent([0.1, 4])
        .on("zoom", (event) => {
            container.attr("transform", event.transform);
        });
    
    svg.call(zoom);
    
    // Create force simulation
    const simulation = d3.forceSimulation(nodes)
        .force("link", d3.forceLink(links).id(d => d.id).distance(150))
        .force("charge", d3.forceManyBody().strength(-500))
        .force("center", d3.forceCenter(svg.node().clientWidth / 2, svg.node().clientHeight / 2))
        .force("collision", d3.forceCollide().radius(40));
    
    // Create links
    const link = container.append("g")
        .selectAll("line")
        .data(links)
        .enter().append("line")
        .attr("class", d => `link similarity-${d.strength} clickable`)
        .attr("stroke", d => d.color)
        .attr("stroke-width", d => d.strength === 'strong' ? 4 : d.strength === 'medium' ? 3 : 2)
        .attr("opacity", 0.7)
        .style("cursor", "pointer")
        .on("click", function(event, d) {
            console.log("Connection clicked:", d);
            showConnectionDetails(d);
        })
        .on("mouseover", function(event, d) {
            d3.select(this).attr("opacity", 1);
            showLinkTooltip(d);
        })
        .on("mouseout", function(event, d) {
            d3.select(this).attr("opacity", 0.7);
            hideLinkTooltip();
        });
    
    // Create nodes
    const node = container.append("g")
        .selectAll("circle")
        .data(nodes)
        .enter().append("circle")
        .attr("r", d => Math.sqrt(d.patient_count) * 2 + 15)
        .attr("fill", d => {
            // Color nodes by patient count (group size)
            if (d.patient_count >= 100) return '#007bff'; // Blue for large groups
            if (d.patient_count >= 50) return '#28a745';  // Green for medium groups
            return '#ffc107'; // Yellow for small groups
        })
        .attr("stroke", "#fff")
        .attr("stroke-width", 3)
        .style("cursor", "pointer")
        .on("click", function(event, d) {
            console.log("Node clicked:", d);
            showNodeDetails(d);
        })
        .on("mouseover", function(event, d) {
            showTooltip(d);
        })
        .on("mouseout", function(event, d) {
            hideTooltip();
        });
    
    // Create labels
    const label = container.append("g")
        .selectAll("text")
        .data(nodes)
        .enter().append("text")
        .text(d => d.name)
        .attr("font-size", "12px")
        .attr("text-anchor", "middle")
        .attr("dy", "0.35em")
        .style("pointer-events", "none")
        .style("opacity", labelsVisible ? 1 : 0)
        .style("fill", "#333");
    
    // Update positions on simulation tick
    simulation.on("tick", () => {
        link
            .attr("x1", d => d.source.x)
            .attr("y1", d => d.source.y)
            .attr("x2", d => d.target.x)
            .attr("y2", d => d.target.y);
        
        node
            .attr("cx", d => d.x)
            .attr("cy", d => d.y);
        
        label
            .attr("x", d => d.x)
            .attr("y", d => d.y);
    });
    
    // Update statistics
    updateStatistics();
    
    // Center the graph after a short delay
    setTimeout(() => {
        centerGraph();
    }, 2000);
}

function updateStatistics() {
    const totalPatients = nodes.reduce((sum, d) => sum + d.patient_count, 0);
    const uniqueTreatments = new Set();
    nodes.forEach(d => {
        d.treatments.forEach(t => uniqueTreatments.add(t));
    });
    
    document.getElementById('node-count').textContent = nodes.length;
    document.getElementById('link-count').textContent = links.length;
    document.getElementById('treatment-count').textContent = uniqueTreatments.size;
    document.getElementById('patient-count').textContent = totalPatients;
}

function showClusterDetails(d) {
    selectedNode = d;
    
    document.getElementById('clusterDetailsTitle').textContent = d.name;
    
    const content = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <h6 class="text-lg font-semibold text-gray-900 mb-4">Cluster Information</h6>
                <div class="space-y-3">
                    <p><span class="font-medium text-gray-700">Patient Count:</span> <span class="text-blue-600">${d.patient_count}</span></p>
                    <p><span class="font-medium text-gray-700">Success Rate:</span> <span class="text-green-600">${d.success_rate}%</span></p>
                    <p><span class="font-medium text-gray-700">Specialty:</span> <span class="text-purple-600">${d.specialty}</span></p>
                    <p><span class="font-medium text-gray-700">Description:</span> <span class="text-gray-600">${d.description}</span></p>
                </div>
            </div>
            <div>
                <h6 class="text-lg font-semibold text-gray-900 mb-4">Treatment Patterns</h6>
                <div class="space-y-3">
                    <div>
                        <p class="font-medium text-gray-700 mb-2">Common Treatments:</p>
                        <div class="flex flex-wrap gap-2">
                            ${d.common_treatments.map(t => `<span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-sm">${t}</span>`).join('')}
                        </div>
                    </div>
                    <div>
                        <p class="font-medium text-gray-700 mb-2">Diagnoses:</p>
                        <div class="flex flex-wrap gap-2">
                            ${d.diagnoses.map(diag => `<span class="px-2 py-1 bg-green-100 text-green-800 rounded text-sm">${diag}</span>`).join('')}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="mt-6">
            <h6 class="text-lg font-semibold text-gray-900 mb-4">Treatment Frequency</h6>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-2 text-left text-sm font-medium text-gray-700 border-b">Treatment</th>
                            <th class="px-4 py-2 text-left text-sm font-medium text-gray-700 border-b">Frequency</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.entries(d.treatment_counts).map(([treatment, count]) => 
                            `<tr class="hover:bg-gray-50">
                                <td class="px-4 py-2 text-sm text-gray-900 border-b">${treatment}</td>
                                <td class="px-4 py-2 text-sm text-gray-600 border-b">${count}</td>
                            </tr>`
                            ).join('')}
                        </tbody>
                    </table>
            </div>
        </div>
    `;
    
    document.getElementById('clusterDetailsBody').innerHTML = content;
    
    // Show modal using Tailwind CSS approach
    const modal = document.getElementById('clusterDetailsModal');
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    
    // Add backdrop
    const backdrop = document.createElement('div');
    backdrop.id = 'cluster-modal-backdrop';
    backdrop.className = 'fixed inset-0 bg-black bg-opacity-50 z-40';
    document.body.appendChild(backdrop);
    
    // Close modal when clicking backdrop
    backdrop.addEventListener('click', closeClusterModal);
    
    // Close modal when clicking close buttons
    document.getElementById('closeClusterModal').addEventListener('click', closeClusterModal);
    document.getElementById('closeClusterModalBtn').addEventListener('click', closeClusterModal);
    
    function closeClusterModal() {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        if (document.getElementById('cluster-modal-backdrop')) {
            document.body.removeChild(document.getElementById('cluster-modal-backdrop'));
        }
    }
}

function showTooltip(d) {
    const tooltip = d3.select("body").append("div")
        .attr("class", "tooltip")
        .style("display", "block")
        .html(`
            <strong>${d.name}</strong><br/>
            Patients: ${d.patient_count}<br/>
            Success Rate: ${d.success_rate}%<br/>
            Specialty: ${d.specialty}<br/>
            Click for details
        `)
        .style("left", (d3.event.pageX + 10) + "px")
        .style("top", (d3.event.pageY - 10) + "px");
}

function hideTooltip() {
    d3.selectAll(".tooltip").remove();
}

function centerGraph() {
    const svg = d3.select("#network-svg");
    const container = svg.select("g");
    const width = svg.node().clientWidth;
    const height = svg.node().clientHeight;
    
    const zoom = d3.zoom()
        .scaleExtent([0.1, 4])
        .on("zoom", (event) => {
            container.attr("transform", event.transform);
        });
    
    // Center the graph properly
    const centerX = width / 2;
    const centerY = height / 2;
    
    svg.transition().duration(750).call(
        zoom.transform,
        d3.zoomIdentity.translate(centerX, centerY).scale(0.8)
    );
}

function exportNetworkData() {
    const data = { nodes, links };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'treatment_similarity_network.json';
    a.click();
    URL.revokeObjectURL(url);
}

function exportNetworkCSV() {
    const csvContent = "data:text/csv;charset=utf-8," + 
        "Cluster,Patient Count,Risk Level,Specialty,Common Treatments,Success Rate\n" +
        nodes.map(d => `${d.name},${d.patient_count},${d.risk_level},${d.specialty},"${d.common_treatments.join(';')}",${d.success_rate}`).join("\n");
    
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "treatment_similarity_network.csv");
    link.click();
}

function exportNetworkImage() {
    const svg = document.getElementById('network-svg');
    const svgData = new XMLSerializer().serializeToString(svg);
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const img = new Image();
    
    canvas.width = svg.clientWidth;
    canvas.height = svg.clientHeight;
    
    img.onload = function() {
        ctx.drawImage(img, 0, 0);
        const pngFile = canvas.toDataURL('image/png');
        const downloadLink = document.createElement('a');
        downloadLink.download = 'treatment_similarity_network.png';
        downloadLink.href = pngFile;
        downloadLink.click();
    };
    
    img.src = 'data:image/svg+xml;base64,' + btoa(svgData);
}

// Filter functionality
document.getElementById('specialty-filter').addEventListener('change', applyFilters);
document.getElementById('treatment-filter').addEventListener('change', applyFilters);
document.getElementById('diagnosis-filter').addEventListener('change', applyFilters);
document.getElementById('risk-filter').addEventListener('change', applyFilters);

function applyFilters() {
    const specialty = document.getElementById('specialty-filter').value;
    const treatment = document.getElementById('treatment-filter').value;
    const diagnosis = document.getElementById('diagnosis-filter').value;
    const risk = document.getElementById('risk-filter').value;
    
    console.log('Applying filters:', { specialty, treatment, diagnosis, risk });
    
    const params = new URLSearchParams();
    if (specialty) params.append('specialty', specialty);
    if (treatment) params.append('treatment', treatment);
    if (diagnosis) params.append('diagnosis', diagnosis);
    if (risk) params.append('risk', risk);
    
    window.location.href = '?' + params.toString();
}

// Show detailed connection information
function showConnectionDetails(d) {
    console.log("showConnectionDetails called with:", d);
    const sourceNode = nodes.find(n => n.id === d.source.id);
    const targetNode = nodes.find(n => n.id === d.target.id);
    console.log("Source node:", sourceNode);
    console.log("Target node:", targetNode);
    
    const content = `
        <div class="row">
            <div class="col-md-6">
                <h6 class="text-primary">Connection Overview</h6>
                <p><strong>Overall Similarity:</strong> ${d.similarity}%</p>
                <p><strong>Connection Strength:</strong> <span class="badge bg-${d.strength === 'strong' ? 'danger' : d.strength === 'medium' ? 'warning' : 'success'}">${d.strength.toUpperCase()}</span></p>
                <p><strong>Why Connected:</strong> ${d.connection_reasons}</p>
            </div>
            <div class="col-md-6">
                <h6 class="text-primary">Detailed Similarity Breakdown</h6>
                <div class="mb-2">
                    <small>Treatment Similarity: ${d.treatment_similarity}%</small>
                    <div class="progress" style="height: 5px;">
                        <div class="progress-bar" style="width: ${d.treatment_similarity}%"></div>
                    </div>
                </div>
                <div class="mb-2">
                    <small>Diagnosis Similarity: ${d.diagnosis_similarity}%</small>
                    <div class="progress" style="height: 5px;">
                        <div class="progress-bar" style="width: ${d.diagnosis_similarity}%"></div>
                    </div>
                </div>
                <div class="mb-2">
                    <small>Demographic Similarity: ${d.demographic_similarity}%</small>
                    <div class="progress" style="height: 5px;">
                        <div class="progress-bar" style="width: ${d.demographic_similarity}%"></div>
                    </div>
                </div>
                <div class="mb-2">
                    <small>Comorbidity Similarity: ${d.comorbidity_similarity}%</small>
                    <div class="progress" style="height: 5px;">
                        <div class="progress-bar" style="width: ${d.comorbidity_similarity}%"></div>
                    </div>
                </div>
                <div class="mb-2">
                    <small>Geographic Similarity: ${d.geographic_similarity}%</small>
                    <div class="progress" style="height: 5px;">
                        <div class="progress-bar" style="width: ${d.geographic_similarity}%"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <hr>
        
        <div class="row">
            <div class="col-md-6">
                <h6 class="text-success">Shared Treatments (${d.shared_treatments.length})</h6>
                <div class="d-flex flex-wrap gap-1">
                    ${d.shared_treatments.map(t => `<span class="badge bg-success">${t}</span>`).join('')}
                </div>
            </div>
            <div class="col-md-6">
                <h6 class="text-info">Shared Diagnoses (${d.shared_diagnoses.length})</h6>
                <div class="d-flex flex-wrap gap-1">
                    ${d.shared_diagnoses.map(diag => `<span class="badge bg-info">${diag}</span>`).join('')}
                </div>
            </div>
        </div>
        
        <div class="row mt-3">
            <div class="col-md-6">
                <h6 class="text-warning">Shared Age Groups (${d.shared_age_groups.length})</h6>
                <div class="d-flex flex-wrap gap-1">
                    ${d.shared_age_groups.map(age => `<span class="badge bg-warning">${age}</span>`).join('')}
                </div>
            </div>
            <div class="col-md-6">
                <h6 class="text-secondary">Shared Zip Codes (${d.shared_zip_codes.length})</h6>
                <div class="d-flex flex-wrap gap-1">
                    ${d.shared_zip_codes.map(zip => `<span class="badge bg-secondary">${zip}</span>`).join('')}
                </div>
            </div>
        </div>
        
        <div class="row mt-3">
            <div class="col-md-6">
                <h6 class="text-primary">Source Cluster: ${sourceNode.name}</h6>
                <p><small>Patients: ${sourceNode.patient_count} | Specialty: ${sourceNode.specialty}</small></p>
            </div>
            <div class="col-md-6">
                <h6 class="text-primary">Target Cluster: ${targetNode.name}</h6>
                <p><small>Patients: ${targetNode.patient_count} | Specialty: ${targetNode.specialty}</small></p>
            </div>
        </div>
    `;
    
    document.getElementById('connection-details').innerHTML = content;
    console.log("About to show connection modal");
    
    // Show modal using Tailwind CSS approach
    const modal = document.getElementById('connectionModal');
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    
    // Add backdrop
    const backdrop = document.createElement('div');
    backdrop.id = 'connection-modal-backdrop';
    backdrop.className = 'fixed inset-0 bg-black bg-opacity-50 z-40';
    document.body.appendChild(backdrop);
    
    // Close modal when clicking backdrop
    backdrop.addEventListener('click', closeConnectionModal);
    
    // Close modal when clicking close buttons
    document.getElementById('closeConnectionModal').addEventListener('click', closeConnectionModal);
    document.getElementById('closeConnectionModalBtn').addEventListener('click', closeConnectionModal);
    
    function closeConnectionModal() {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        if (document.getElementById('connection-modal-backdrop')) {
            document.body.removeChild(document.getElementById('connection-modal-backdrop'));
        }
    }
}

// Show detailed node information
function showNodeDetails(d) {
    console.log("showNodeDetails called with:", d);
    
    // Add error handling for missing properties
    const safeCommonTreatments = d.common_treatments || [];
    const safeDiagnoses = d.diagnoses || [];
    const safeTreatmentCounts = d.treatment_counts || {};
    
    const content = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <h5 class="text-blue-600 text-lg font-semibold mb-2">${d.name || 'Unknown Cluster'}</h5>
                <p class="text-gray-600 mb-4">${d.description || 'No description available'}</p>
                
                <div class="space-y-4">
                    <div>
                        <h6 class="text-green-600 font-semibold mb-2">Patient Statistics</h6>
                        <div class="space-y-1">
                            <p><span class="font-medium">Total Patients:</span> ${d.patient_count || 0}</p>
                            <p><span class="font-medium">Success Rate:</span> ${d.success_rate || 0}%</p>
                            <p><span class="font-medium">Specialty:</span> ${d.specialty || 'Unknown'}</p>
                        </div>
                    </div>
                    
                    <div>
                        <h6 class="text-blue-600 font-semibold mb-2">Common Treatments</h6>
                        <div class="flex flex-wrap gap-2">
                            ${safeCommonTreatments.length > 0 ? 
                                safeCommonTreatments.slice(0, 10).map(t => `<span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-sm">${t}</span>`).join('') +
                                (safeCommonTreatments.length > 10 ? `<span class="px-2 py-1 bg-gray-100 text-gray-600 rounded text-sm">+${safeCommonTreatments.length - 10} more</span>` : '') :
                                '<span class="text-gray-500 text-sm">No treatment data available</span>'
                            }
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="space-y-4">
                <div>
                    <h6 class="text-yellow-600 font-semibold mb-2">Primary Diagnoses</h6>
                    <div class="flex flex-wrap gap-2">
                        ${safeDiagnoses.length > 0 ? 
                            safeDiagnoses.slice(0, 8).map(diag => `<span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded text-sm">${diag}</span>`).join('') +
                            (safeDiagnoses.length > 8 ? `<span class="px-2 py-1 bg-gray-100 text-gray-600 rounded text-sm">+${safeDiagnoses.length - 8} more</span>` : '') :
                            '<span class="text-gray-500 text-sm">No diagnosis data available</span>'
                        }
                    </div>
                </div>
                
                <div>
                    <h6 class="text-gray-600 font-semibold mb-2">Treatment Distribution</h6>
                    <div class="space-y-2">
                        ${Object.keys(safeTreatmentCounts).length > 0 ? 
                            Object.entries(safeTreatmentCounts).slice(0, 5).map(([treatment, count]) => 
                                `<div class="flex justify-between items-center">
                                    <span class="text-sm">${treatment}</span>
                                    <span class="px-2 py-1 bg-gray-100 text-gray-700 rounded text-xs">${count}</span>
                                </div>`
                            ).join('') :
                            '<span class="text-gray-500 text-sm">No treatment distribution data available</span>'
                        }
                    </div>
                </div>
                
                <div>
                    <h6 class="text-blue-600 font-semibold mb-2">Cluster Insights</h6>
                    <div class="bg-blue-50 p-3 rounded">
                        <p class="text-sm text-blue-800">
                            <span class="font-medium">Clinical Relevance:</span> This cluster represents patients with similar 
                            treatment patterns, demographics, and clinical outcomes. The high similarity 
                            suggests these patients may benefit from similar care protocols.
                        </p>
                    </div>
                    
                    <div class="mt-3">
                        <h6 class="text-green-600 font-semibold mb-2">Connection Summary</h6>
                        <p class="text-sm text-gray-600">
                            This cluster is connected to other clusters based on shared treatments, 
                            similar patient demographics, and overlapping diagnoses. Click on the 
                            connections to see detailed similarity analysis.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('node-details').innerHTML = content;
    
    // Show modal using Tailwind CSS approach
    const modal = document.getElementById('nodeModal');
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    
    // Add backdrop
    const backdrop = document.createElement('div');
    backdrop.id = 'modal-backdrop';
    backdrop.className = 'fixed inset-0 bg-black bg-opacity-50 z-40';
    document.body.appendChild(backdrop);
    
    // Close modal when clicking backdrop
    backdrop.addEventListener('click', closeModal);
    
    // Close modal when clicking close button
    document.getElementById('closeModal').addEventListener('click', closeModal);
    document.getElementById('closeModalBtn').addEventListener('click', closeModal);
    
    function closeModal() {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        if (document.getElementById('modal-backdrop')) {
            document.body.removeChild(document.getElementById('modal-backdrop'));
        }
    }
}

// Link tooltip functions
function showLinkTooltip(d) {
    const tooltip = d3.select("body").append("div")
        .attr("class", "tooltip")
        .style("display", "block")
        .html(`
            <strong>Connection Details</strong><br/>
            Similarity: ${d.similarity}%<br/>
            Strength: ${d.strength}<br/>
            Click for detailed analysis
        `)
        .style("left", (d3.event.pageX + 10) + "px")
        .style("top", (d3.event.pageY - 10) + "px");
}

function hideLinkTooltip() {
    d3.selectAll(".tooltip").remove();
}
</script>

<style>
.link {
    stroke-opacity: 0.7;
}

.link.similarity-strong {
    stroke-width: 4px;
}

.link.similarity-medium {
    stroke-width: 3px;
}

.link.similarity-weak {
    stroke-width: 2px;
}

.tooltip {
    position: absolute;
    padding: 10px;
    background: rgba(0, 0, 0, 0.8);
    color: white;
    border-radius: 4px;
    pointer-events: none;
    font-size: 12px;
    z-index: 1000;
}

.clickable {
    cursor: pointer;
}

.clickable:hover {
    opacity: 0.8;
}
</style>

<!-- Connection Details Modal -->
<div id="connectionModal" class="hidden fixed inset-0 z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center p-6 border-b">
            <h5 class="text-xl font-semibold text-gray-900" id="connectionModalLabel">Connection Analysis</h5>
            <button id="closeConnectionModal" class="text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        <div class="p-6">
            <div id="connection-details">
                <!-- Connection details will be populated here -->
            </div>
        </div>
        <div class="flex justify-end p-6 border-t">
            <button id="closeConnectionModalBtn" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">Close</button>
        </div>
    </div>
</div>

<!-- Node Details Modal -->
<div id="nodeModal" class="hidden fixed inset-0 z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center p-6 border-b">
            <h5 class="text-xl font-semibold text-gray-900">Cluster Details</h5>
            <button id="closeModal" class="text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        <div class="p-6">
            <div id="node-details">
                <!-- Node details will be populated here -->
            </div>
        </div>
        <div class="flex justify-end p-6 border-t">
            <button id="closeModalBtn" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">Close</button>
        </div>
    </div>
</div>

{% endblock %}